{% load static %}
{% load i18n %}

<!-- Product Variants Form Component - TEST VERSION -->
<div class="form-section" id="variants-section">
    <label class="toggle-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
        <input type="checkbox" id="has_variants" name="has_variants"
               onchange="toggleVariantsSection(this)"
               style="display: none;"
               {% if existing_variants or preserved_variant_attributes %}checked{% endif %}>
      
        <span class="toggle-switch" style="width: 50px; height: 25px; background: {% if existing_variants or preserved_variant_attributes %}#4CAF50{% else %}#ccc{% endif %}; border-radius: 25px; position: relative; transition: background 0.3s;">
          <span style="position: absolute; top: 2px; left: 2px; width: 21px; height: 21px; background: white; border-radius: 50%; transition: transform 0.3s; {% if existing_variants or preserved_variant_attributes %}transform: translateX(25px);{% endif %}"></span>
        </span>
        Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø§Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„Ù Ø¯Ø§Ø±Ø¯
      </label>
      

    
    <div class="section-content" id="variants-content" style="{% if existing_variants or preserved_variant_attributes %}display: block;{% else %}display: none;{% endif %}">
        <p>Variants content loaded</p>
        
        <!-- Variant Attributes Selection -->
        <div class="variant-attributes-selection">
            <h3>Ø§Ù†ØªØ®Ø§Ø¨ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ØªØºÛŒØ±</h3>
            <p class="description">ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ù‡Ø³ØªÙ†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
            <div class="variant-attributes-grid" id="variantAttributesGrid">
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    Ø§Ø¨ØªØ¯Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
                </p>
            </div>
        </div>
        
        <!-- Script to restore preserved variant attributes -->
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Restore preserved variant attributes if they exist
            const preservedVariantAttributes = {{ preserved_variant_attributes|safe }};
            if (preservedVariantAttributes && preservedVariantAttributes.length > 0) {
                console.log('ğŸ”„ Restoring preserved variant attributes:', preservedVariantAttributes);
                
                // Wait for category attributes to load, then restore selection
                setTimeout(function() {
                    preservedVariantAttributes.forEach(function(attrKey) {
                        const attributeItem = document.querySelector(`[data-attribute="${attrKey}"]`);
                        if (attributeItem) {
                            const checkbox = attributeItem.querySelector('input[type="checkbox"]');
                            if (checkbox) {
                                checkbox.checked = true;
                                attributeItem.classList.add('selected');
                                console.log('âœ… Restored variant attribute:', attrKey);
                            }
                        }
                    });
                }, 1000);
            }

            // Normalize variants toggle: if no preserved attrs and no existing variants, force OFF
            try {
                const hasVariants = document.getElementById('has_variants');
                const existingVariantsScript = document.getElementById('existing-variants-data');
                let existingVariants = [];
                if (existingVariantsScript && existingVariantsScript.textContent) {
                    try { existingVariants = JSON.parse(existingVariantsScript.textContent) || []; } catch (e) { existingVariants = []; }
                }
                const shouldForceOff = (!preservedVariantAttributes || preservedVariantAttributes.length === 0) && (!existingVariants || existingVariants.length === 0);
                if (hasVariants && shouldForceOff) {
                    hasVariants.checked = false;
                    // Also ensure any stale hidden variant_attributes input is removed
                    const formEl = document.getElementById('product_form');
                    const stale = formEl ? formEl.querySelector('input[name="variant_attributes"]') : null;
                    if (stale) stale.parentNode.removeChild(stale);
                    // Hide variants content
                    const content = document.getElementById('variants-content');
                    if (content) content.style.display = 'none';
                    console.log('ğŸ”§ Normalized: forced variants OFF (no preserved attributes, no existing variants)');
                }
            } catch (e) {
                console.warn('âš ï¸ Could not normalize variants toggle:', e);
            }
        });
        </script>

        <!-- Variant Modal moved to main document for full screen access -->
        
        <!-- Variants Management Table -->
        <div class="variants-management" id="variantsManagement" style="margin-top: 20px;">
            <div class="management-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†ÙˆØ§Ø¹ Ù…Ø­ØµÙˆÙ„</h3>
                <div class="management-actions" style="display: flex; gap: 10px;">
                    <button type="button" onclick="openVariantModalForAdd();" style="background: blue; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">+ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÛŒ</button>
                    <button type="button" onclick="testLoadCategoryAttributes();" style="background: green; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">ØªØ³Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§</button>
                    <button type="button" onclick="window.testVariantUI();" style="background: orange; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">ØªØ³Øª UI Ù…Ø³ØªÙ‚ÛŒÙ…</button>
                    <button type="button" onclick="window.debugSelection();" style="background: red; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Ø¯ÛŒØ¨Ø§Ú¯ Ø§Ù†ØªØ®Ø§Ø¨</button>
                    <button type="button" onclick="window.testMultiSelection();" style="background: purple; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">ØªØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡</button>
                    <button type="button" onclick="window.testVariantModalForm();" style="background: teal; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">ØªØ³Øª ÙØ±Ù… Ù…ÙˆØ¯Ø§Ù„</button>
                </div>
            </div>
            <div class="variants-table-container" style="overflow-x: auto;">
                <table class="variants-table" id="variantsTable" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Ú©Ø¯ Ù…Ø­ØµÙˆÙ„ (SKU)</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">ÙˆØ¶Ø¹ÛŒØª</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="variantsTableBody">
                        <!-- Variant rows will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle functionality for test version
function toggleVariantsSection(checkbox) {
    console.log('ğŸ”„ Toggling variants section:', checkbox.checked);
    const content = document.getElementById('variants-content');
    const toggleSwitch = checkbox.nextElementSibling;
    const toggleKnob = toggleSwitch.querySelector('span');
    
    if (content) {
        content.style.display = checkbox.checked ? 'block' : 'none';
    }
    
    // Update toggle visual state
    if (checkbox.checked) {
        toggleSwitch.style.background = '#4CAF50';
        toggleKnob.style.transform = 'translateX(25px)';

        
        // âœ¨ CRITICAL: Disable main image upload when variants are enabled
        console.log('ğŸ”„ Variants enabled - disabling main image upload...');
        const mainImageInput = document.getElementById('imageInput');
        const mainImageSection = document.querySelector('.image-section');
        console.log('ğŸ” Main image input found:', !!mainImageInput);
        console.log('ğŸ” Main image section found:', !!mainImageSection);
        
        if (mainImageInput) {
            mainImageInput.disabled = true;
            console.log('âœ… Main image input disabled');
        } else {
            console.error('âŒ Main image input not found!');
        }
        
        if (mainImageSection) {
            const uploadArea = mainImageSection.querySelector('.upload-area');
            console.log('ğŸ” Upload area found:', !!uploadArea);
            if (uploadArea) {
                uploadArea.style.opacity = '0.5';
                uploadArea.style.cursor = 'not-allowed';
                uploadArea.style.pointerEvents = 'none';
                console.log('âœ… Main upload area disabled');
            } else {
                console.error('âŒ Upload area not found in main image section!');
            }
        } else {
            console.error('âŒ Main image section not found!');
        }
        
        // Update main image section description
        const mainImageDesc = document.getElementById('mainImageDescription');
        if (mainImageDesc) {
            mainImageDesc.textContent = 'ØªØµØ§ÙˆÛŒØ± Ù…Ø´ØªØ±Ú© Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø§Ù†ÙˆØ§Ø¹ Ù…Ø­ØµÙˆÙ„. Ø¨Ø±Ø§ÛŒ ØªØµØ§ÙˆÛŒØ± Ù…Ø®ØµÙˆØµ Ù‡Ø± Ù†ÙˆØ¹ØŒ Ø§Ø² Ø¨Ø®Ø´ "Ø§Ù†ÙˆØ§Ø¹ Ù…Ø­ØµÙˆÙ„" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯';
            console.log('âœ… Main image description updated for variants');
        }
        
        // Enable variant modal image upload section
        const variantModal = document.getElementById('variantModal');
        console.log('ğŸ” Variant modal found:', !!variantModal);
        
        if (variantModal) {
            const variantImageInput = variantModal.querySelector('#variantImageInput');
            const variantUploadArea = variantModal.querySelector('.upload-area');
            console.log('ğŸ” Variant image input found:', !!variantImageInput);
            console.log('ğŸ” Variant upload area found:', !!variantUploadArea);
            
            if (variantImageInput) {
                variantImageInput.disabled = false;
                console.log('âœ… Variant image input enabled');
            } else {
                console.error('âŒ Variant image input not found!');
            }
            
            if (variantUploadArea) {
                variantUploadArea.style.opacity = '1';
                variantUploadArea.style.cursor = 'pointer';
                variantUploadArea.style.pointerEvents = 'auto';
                console.log('âœ… Variant upload area enabled');
            } else {
                console.error('âŒ Variant upload area not found!');
            }
        } else {
            console.error('âŒ Variant modal not found!');
        }
        
        // âœ¨ When variants are enabled, refresh category attributes to filter out variant attributes
        console.log('ğŸ”„ Variants enabled - filtering category attributes...');
        const categorySelect = document.getElementById('id_category');
        if (categorySelect && categorySelect.value && typeof window.loadCategoryAttributes === 'function') {
            window.loadCategoryAttributes(categorySelect.value);
            console.log('âœ… Category attributes refreshed to hide variant attributes');
        }
    } else {
        toggleSwitch.style.background = '#ccc';
        toggleKnob.style.transform = 'translateX(0)';

        
        // âœ¨ CRITICAL: Restore main image upload when variants are disabled
        console.log('ğŸ”„ Variants disabled - restoring main image upload...');
        const mainImageInput = document.getElementById('imageInput');
        const mainImageSection = document.querySelector('.image-section');
        console.log('ğŸ” Restoring main image input found:', !!mainImageInput);
        console.log('ğŸ” Restoring main image section found:', !!mainImageSection);
        
        if (mainImageInput) {
            mainImageInput.disabled = false;
            console.log('âœ… Main image input restored');
        } else {
            console.error('âŒ Main image input not found for restoration!');
        }
        
        if (mainImageSection) {
            const uploadArea = mainImageSection.querySelector('.upload-area');
            console.log('ğŸ” Restoring upload area found:', !!uploadArea);
            if (uploadArea) {
                uploadArea.style.opacity = '1';
                uploadArea.style.cursor = 'pointer';
                uploadArea.style.pointerEvents = 'auto';
                console.log('âœ… Main upload area restored');
            } else {
                console.error('âŒ Upload area not found for restoration!');
            }
        } else {
            console.error('âŒ Main image section not found for restoration!');
        }
        
        // Update main image section description
        const mainImageDesc = document.getElementById('mainImageDescription');
        if (mainImageDesc) {
            mainImageDesc.textContent = 'ØªØµØ§ÙˆÛŒØ± Ø§ØµÙ„ÛŒ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø§Ù†ÙˆØ§Ø¹ Ù…Ø­ØµÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯';
            console.log('âœ… Main image description restored');
        }
        
        // Disable variant modal image upload section
        const variantModal = document.getElementById('variantModal');
        console.log('ğŸ” Disabling variant modal found:', !!variantModal);
        
        if (variantModal) {
            const variantImageInput = variantModal.querySelector('#variantImageInput');
            const variantUploadArea = variantModal.querySelector('.upload-area');
            console.log('ğŸ” Disabling variant image input found:', !!variantImageInput);
            console.log('ğŸ” Disabling variant upload area found:', !!variantUploadArea);
            
            if (variantImageInput) {
                variantImageInput.disabled = true;
                console.log('âœ… Variant image input disabled');
            } else {
                console.error('âŒ Variant image input not found for disabling!');
            }
            
            if (variantUploadArea) {
                variantUploadArea.style.opacity = '0.5';
                variantUploadArea.style.cursor = 'not-allowed';
                variantUploadArea.style.pointerEvents = 'none';
                console.log('âœ… Variant upload area disabled');
            } else {
                console.error('âŒ Variant upload area not found for disabling!');
            }
        } else {
            console.error('âŒ Variant modal not found for disabling!');
        }
        
        // âœ¨ NEW: Clear all selected attributes when variants are disabled
        console.log('ğŸ”„ Clearing all selected variant attributes...');
        const selectedAttributes = document.querySelectorAll('.variant-attribute-item.selected');
        selectedAttributes.forEach(item => {
            const itemCheckbox = item.querySelector('input[type="checkbox"]');
            if (itemCheckbox) {
                itemCheckbox.checked = false;
            }
            item.classList.remove('selected');
            console.log('âœ… Cleared attribute:', item.querySelector('.variant-attribute-name')?.textContent);
        });
        
        // Hide variants management section since no attributes are selected
        const variantsManagement = document.getElementById('variantsManagement');
        if (variantsManagement) {
            variantsManagement.style.display = 'none';
            console.log('âœ… Hidden variants management section');
        }
        
        // âœ¨ When variants are disabled, show ALL category attributes
        console.log('ğŸ”„ Variants disabled - showing all category attributes...');
        const categorySelect = document.getElementById('id_category');
        if (categorySelect && categorySelect.value && typeof window.loadCategoryAttributes === 'function') {
            window.loadCategoryAttributes(categorySelect.value);
            console.log('âœ… All category attributes displayed');
        }
        
        console.log('âœ… All variant attributes cleared successfully');
    }
}

// Test function to load category attributes
function testLoadCategoryAttributes() {
    console.log('ğŸ§ª Testing category attributes loading...');
    
    const categorySelect = document.getElementById('id_category');
    if (categorySelect && categorySelect.value) {
        console.log('ğŸ” Selected category:', categorySelect.value);
        if (typeof window.loadCategoryAttributes === 'function') {
            window.loadCategoryAttributes(categorySelect.value);
        } else {
            console.error('âŒ loadCategoryAttributes function not found!');
        }
    } else {
        console.log('âš ï¸ No category selected. Please select a category first.');
        alert('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
    }
}

// Make functions global
window.toggleVariantsSection = toggleVariantsSection;
window.testLoadCategoryAttributes = testLoadCategoryAttributes;
</script>
