{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Add Product" %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{% static 'shop/js/product_tags.js' %}"></script>
    <script src="{% static 'shop/js/image_editor.js' %}"></script>
    
    <!-- Remove hidden elements and debug output for product_attributes.js -->
    <!-- Add hidden element for existing attributes data -->
    <!-- <script id="existing-attrs-data" type="application/json">
        {{ existing_attrs|safe }}
    </script> -->
    
    <!-- Add hidden element for category attributes data -->
    <!-- <script id="category-attributes-data" type="application/json">
        {{ category_attributes|safe }}
    </script> -->
    
    <!-- Debug output -->
    <!-- <script>
        console.log('üîç TEMPLATE DEBUG: category_attributes length:', '{{ category_attributes|safe }}'.length);
        console.log('üîç TEMPLATE DEBUG: category_attributes preview:', '{{ category_attributes|safe }}'.substring(0, 200));
        setTimeout(() => {
            const element = document.getElementById('category-attributes-data');
            console.log('üîç TEMPLATE TEST: category-attributes-data element found:', !!element);
            if (element) {
                console.log('üîç TEMPLATE TEST: Element content length:', element.textContent.length);
                console.log('üîç TEMPLATE TEST: Element content preview:', element.textContent.substring(0, 200));
            }
        }, 100);
    </script> -->
    
    <!-- Add hidden element for category tags data -->
    <script id="category-tags-data" type="application/json">
        {{ category_tags|safe }}
    </script>
    
    <!-- Add hidden element for selected tags data -->
    <script id="selected-tags-data" type="application/json">
        {{ selected_tags|safe }}
    </script>
    
    <!-- Add hidden element for existing variants data -->
    <script id="existing-variants-data" type="application/json">
        {{ existing_variants_json|safe }}
    </script>
    
    <!-- Add hidden element for product images data -->
    <script id="product-images-data" type="application/json">
        {{ product_images|safe }}
    </script>
    
    <!-- Add this simple theme toggle script at the top -->
    <script>
        // GLOBAL SAVE FUNCTION - SIMPLIFIED
        function handleSaveClick(button) {
            console.log('üîò Save button clicked:', button.value);
            
            // Get the form
            const form = document.getElementById('product_form');
            if (form) {
                // Try to add variant data if function exists
                if (typeof addVariantDataToForm === 'function') {
                    console.log('üîÑ Adding variant data to form');
                    try {
                    addVariantDataToForm();
                    } catch (e) {
                        console.log('‚ö†Ô∏è Error adding variant data:', e);
                    }
                }
                
                console.log('üì§ Submitting form...');
                // Just submit the form normally
                return true; // Allow normal form submission
            } else {
                console.log('‚ùå Form not found!');
                return false;
            }
        }
        
        // Make function global
        window.handleSaveClick = handleSaveClick;
        
        // Force add variants for testing
        window.forceAddVariants = function() {
            console.log('üß™ Force adding variants for testing...');
            
            const form = document.getElementById('product_form');
            if (!form) {
                console.log('‚ùå Form not found!');
                return;
            }
            
            // Remove existing variant inputs
            const existingInputs = form.querySelectorAll('input[name="variants_data"], input[name="variant_attributes"]');
            existingInputs.forEach(input => input.remove());
            
            // Add test variant data directly
            const testVariants = [
                {
                    id: 'test-1',
                    sku: 'TEST-VARIANT-001',
                    attributes: { color: 'ŸÇÿ±ŸÖÿ≤', size: 'M' },
                    priceToman: '150000',
                    stock: 10,
                    isActive: true
                },
                {
                    id: 'test-2', 
                    sku: 'TEST-VARIANT-002',
                    attributes: { color: 'ÿ¢ÿ®€å', size: 'L' },
                    priceToman: '160000', 
                    stock: 15,
                    isActive: true
                }
            ];
            
            const variantDataInput = document.createElement('input');
            variantDataInput.type = 'hidden';
            variantDataInput.name = 'variants_data';
            variantDataInput.value = JSON.stringify(testVariants);
            form.appendChild(variantDataInput);
            
            console.log('‚úÖ Forced variant data added:', variantDataInput.value);
            
            // Verify it's there
            const checkInput = form.querySelector('input[name="variants_data"]');
            if (checkInput) {
                console.log('‚úÖ Verification: variants_data found with value:', checkInput.value);
            } else {
                console.log('‚ùå Verification: variants_data NOT found!');
            }
        };
        
        // TEST: Check if JavaScript is working at all
        console.log('üöÄ JavaScript is loading...');
        console.log('‚úÖ handleSaveClick function defined:', typeof handleSaveClick);
        // Removed alert that was blocking execution
        
        // Global variant functions that need to be accessible from onclick handlers
        function toggleAttributeSelection(element, attrName) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
            
            // Show/hide variant management section based on selection
            const variantsManagement = document.getElementById('variantsManagement');
            const selectedCount = document.querySelectorAll('.variant-attribute-item.selected').length;
            
            console.log('üîç toggleAttributeSelection called for:', attrName);
            console.log('üîç Checkbox checked:', checkbox.checked);
            console.log('üîç Selected count:', selectedCount);
            console.log('üîç variantsManagement found:', !!variantsManagement);
            
            if (variantsManagement) {
            if (selectedCount > 0) {
                    variantsManagement.style.display = 'block';
                    console.log('‚úÖ Showing variants management section');
            } else {
                    variantsManagement.style.display = 'none';
                    console.log('‚ùå Hiding variants management section');
                }
            } else {
                console.log('‚ùå variantsManagement element not found!');
            }
        }

        function generateTestVariants() {
            const selectedAttrs = document.querySelectorAll('.variant-attribute-item.selected');
            let combinations = [];
            
            if (selectedAttrs.length > 0) {
                // Simple test: create 6 variants
                const variants = [
                    { sku: 'TSH-001-RED-M', attrs: 'ÿ±ŸÜ⁄Ø: ŸÇÿ±ŸÖÿ≤ ÿ≥ÿß€åÿ≤: M', price: '150000', stock: '10' },
                    { sku: 'TSH-002-BLUE-L', attrs: 'ÿ±ŸÜ⁄Ø: ÿ¢ÿ®€å ÿ≥ÿß€åÿ≤: L', price: '150000', stock: '15' },
                    { sku: 'TSH-003-WHITE-S', attrs: 'ÿ±ŸÜ⁄Ø: ÿ≥ŸÅ€åÿØ ÿ≥ÿß€åÿ≤: S', price: '140000', stock: '20' },
                    { sku: 'TSH-004-BLACK-XL', attrs: 'ÿ±ŸÜ⁄Ø: ÿ≥€åÿßŸá ÿ≥ÿß€åÿ≤: XL', price: '160000', stock: '8' },
                    { sku: 'TSH-005-GREEN-M', attrs: 'ÿ±ŸÜ⁄Ø: ÿ≥ÿ®ÿ≤ ÿ≥ÿß€åÿ≤: M', price: '150000', stock: '12' },
                    { sku: 'TSH-006-RED-L', attrs: 'ÿ±ŸÜ⁄Ø: ŸÇÿ±ŸÖÿ≤ ÿ≥ÿß€åÿ≤: L', price: '150000', stock: '18' }
                ];
                
                const table = document.getElementById('variantsTableBody');
                variants.forEach(variant => {
                    const row = table.insertRow();
                    row.innerHTML = `<td>${variant.sku}</td><td>${variant.attrs}</td><td>${parseInt(variant.price).toLocaleString()} ÿ™ŸàŸÖÿßŸÜ</td><td>${variant.stock}</td><td>ŸÅÿπÿßŸÑ</td><td><button onclick="this.closest('tr').remove()">ÿ≠ÿ∞ŸÅ</button></td>`;
                });
                
                alert('‚úÖ ' + variants.length + ' ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿß€åÿ¨ÿßÿØ ÿ¥ÿØ!');
                
                // Show management section
                document.getElementById('variantsManagement').style.display = 'block';
            } else {
                alert('‚ö†Ô∏è ŸÑÿ∑ŸÅÿß ÿ≠ÿØÿßŸÇŸÑ €å⁄© Ÿà€å⁄ò⁄Ø€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ');
            }
        }

        // TEST FUNCTION - Simple form submission test
        function testSimpleSubmission() {
            console.log('üß™ Testing simple form submission...');
            
            // Create a completely clean FormData object
            const formData = new FormData();
            
            // Add only the essential fields that ProductForm expects
            formData.set('name', 'Test Product');
            formData.set('description', 'Test Description');
            formData.set('price_toman', '100000');
            formData.set('stock_quantity', '10');
            formData.set('category', '1040'); // Use Test Category which has no attributes
            formData.set('is_active', 'true');
            
            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            formData.set('csrfmiddlewaretoken', csrfToken);
            
            console.log('üìã Test form data (completely clean):');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}:`, value);
            }
            
            // Check if any attr_ fields somehow got added
            let hasAttrFields = false;
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('attr_')) {
                    console.error(`‚ùå Found attr field: ${key} = ${value}`);
                    hasAttrFields = true;
                }
            }
            if (hasAttrFields) {
                alert('‚ùå ERROR: attr_ fields found in clean FormData! This should not happen!');
                return;
            }
            
            const form = document.getElementById('product_form');
            console.log('üîç Form action:', form.action);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('üì• Raw response:', response);
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Test response:', data);
                if (data.success) {
                    alert('‚úÖ ÿ™ÿ≥ÿ™ ŸÖŸàŸÅŸÇ! ŸÅÿ±ŸÖ ⁄©ÿßÿ± ŸÖ€å‚Äå⁄©ŸÜÿØ');
                } else {
                    alert('‚ùå ÿ™ÿ≥ÿ™ ŸÜÿßŸÖŸàŸÅŸÇ: ' + data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå Test error:', error);
                alert('‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿ™ÿ≥ÿ™: ' + error.message);
            });
        }

        // TEST FUNCTION - Direct form submission without JavaScript
        function testDirectSubmission() {
            console.log('üß™ Testing direct form submission...');
            
            const form = document.getElementById('product_form');
            if (!form) {
                alert('‚ùå ŸÅÿ±ŸÖ Ÿæ€åÿØÿß ŸÜÿ¥ÿØ!');
                return;
            }
            
            // Fill in required fields
            const nameField = form.querySelector('input[name="name"]');
            const priceField = form.querySelector('input[name="price_toman"]');
            const stockField = form.querySelector('input[name="stock_quantity"]');
            const categoryField = form.querySelector('select[name="category"]');
            
            if (nameField) nameField.value = 'Test Product Direct';
            if (priceField) priceField.value = '100000';
            if (stockField) stockField.value = '10';
            if (categoryField) categoryField.value = '1040'; // Use Test Category which has no attributes
            
            console.log('üìã Form fields filled, submitting directly...');
            console.log('üìã Form action:', form.action);
            console.log('üìã Form method:', form.method);
            
            // Create a temporary form for direct submission
            const tempForm = document.createElement('form');
            tempForm.method = 'POST';
            tempForm.action = form.action;
            tempForm.style.display = 'none';
            
            // Copy all form data
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                tempForm.appendChild(input);
            }
            
            // Add to document and submit
            document.body.appendChild(tempForm);
            tempForm.submit();
        }

        // TEST FUNCTION - Regular form submission (simplest approach)
        function testRegularSubmit() {
            console.log('üß™ Testing regular form submission...');
            
            const form = document.getElementById('product_form');
            if (!form) {
                alert('‚ùå ŸÅÿ±ŸÖ Ÿæ€åÿØÿß ŸÜÿ¥ÿØ!');
                return;
            }
            
            // Fill in required fields
            const nameField = form.querySelector('input[name="name"]');
            const priceField = form.querySelector('input[name="price_toman"]');
            const stockField = form.querySelector('input[name="stock_quantity"]');
            const categoryField = form.querySelector('select[name="category"]');
            
            if (nameField) nameField.value = 'Test Product Regular';
            if (priceField) priceField.value = '100000';
            if (stockField) stockField.value = '10';
            if (categoryField) categoryField.value = '1040'; // Use Test Category which has no attributes
            
            console.log('üìã Form fields filled, submitting regularly...');
            
            // Temporarily disable the JavaScript handler
            const originalHandler = form.onsubmit;
            form.onsubmit = null;
            
            // Submit the form
            form.submit();
            
            // Restore the handler (though the page will reload anyway)
            form.onsubmit = originalHandler;
        }

        // OLD HARDCODED SAVE VARIANT FUNCTION REMOVED - NOW USING DYNAMIC VERSION BELOW

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            const isLight = body.classList.toggle('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            themeToggle.querySelector('i').textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
            return false;
        }

        function toggleLanguage() {
            const body = document.body;
            const languageToggle = document.getElementById('languageToggle');
            const isRTL = body.getAttribute('dir') === 'rtl';
            
            if (isRTL) {
                body.setAttribute('dir', 'ltr');
                languageToggle.innerHTML = `
                    <img src="{% static 'shop/images/fa-flag.png' %}" alt="ŸÅÿßÿ±ÿ≥€å" class="fa-flag">
                    <span>ŸÅÿßÿ±ÿ≥€å</span>
                `;
            } else {
                body.setAttribute('dir', 'rtl');
                languageToggle.innerHTML = `
                    <img src="{% static 'shop/images/en-flag.png' %}" alt="English" class="en-flag">
                    <span>English</span>
                `;
            }
            
            localStorage.setItem('language', isRTL ? 'ltr' : 'rtl');
            return false;
        }
        
        // Add this new function to format numbers with commas
        function formatNumberWithCommas(inputField) {
            // Get input value and remove non-numeric characters except decimal point
            let value = inputField.value.replace(/[^\d.]/g, '');
            
            // Handle decimal part separately if exists
            let decimalPart = '';
            if (value.includes('.')) {
                const parts = value.split('.');
                value = parts[0];
                decimalPart = '.' + parts[1];
            }
            
            // Format the whole number part with commas
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            // Combine with decimal part if it exists
            inputField.value = value + decimalPart;
        }

        // Add this function to prepare numbers for form submission
        function prepareNumbersForSubmit() {
            const priceToman = document.getElementById('price_toman');
            const priceUsd = document.getElementById('price_usd');
            
            if (priceToman) {
                priceToman.value = priceToman.value.replace(/,/g, '');
            }
            if (priceUsd) {
                priceUsd.value = priceUsd.value.replace(/,/g, '');
            }
        }

        // Apply theme and language on page load
        function applySettings() {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const currentLanguage = localStorage.getItem('language') || 'rtl';
            
            if (currentTheme === 'light') {
                document.body.classList.add('light-theme');
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.querySelector('i').textContent = 'üåô';
                }
            }
            
            if (currentLanguage === 'ltr') {
                document.body.setAttribute('dir', 'ltr');
                const languageToggle = document.getElementById('languageToggle');
                if (languageToggle) {
                    languageToggle.innerHTML = `
                        <img src="{% static 'shop/images/fa-flag.png' %}" alt="ŸÅÿßÿ±ÿ≥€å" class="fa-flag">
                        <span>ŸÅÿßÿ±ÿ≥€å</span>
                    `;
                }
            }
        }
        
        // Run after page has loaded
        window.addEventListener('DOMContentLoaded', applySettings);
    </script>
    
    <style>
        :root {
            /* Dark theme variables */
            --primary-color-dark: #6c5ce7;
            --secondary-color-dark: #a8a4e6;
            --background-color-dark: #1a1a1a;
            --card-bg-dark: rgba(30, 30, 30, 0.8);
            --text-color-dark: #ffffff;
            --text-secondary-dark: #b3b3b3;
            --border-color-dark: rgba(255, 255, 255, 0.1);

            /* Light theme variables */
            --primary-color-light: #5850ec;
            --secondary-color-light: #7b79e5;
            --background-color-light: #f7f9fc;
            --card-bg-light: rgba(255, 255, 255, 0.9);
            --text-color-light: #1a1a1a;
            --text-secondary-light: #4a5568;
            --border-color-light: rgba(0, 0, 0, 0.1);

            /* Default to dark theme */
            --primary-color: var(--primary-color-dark);
            --secondary-color: var(--secondary-color-dark);
            --background-color: var(--background-color-dark);
            --card-bg: var(--card-bg-dark);
            --text-color: var(--text-color-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-color: var(--border-color-dark);
            
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        /* Light theme class */
        body.light-theme {
            --primary-color: var(--primary-color-light);
            --secondary-color: var(--secondary-color-light);
            --background-color: var(--background-color-light);
            --card-bg: var(--card-bg-light);
            --text-color: var(--text-color-light);
            --text-secondary: var(--text-secondary-light);
            --border-color: var(--border-color-light);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            color: var(--text-color);
        }

        body[dir="ltr"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body[dir="rtl"] {
            font-family: 'Doran', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            width: 100%;
            max-width: 1600px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }

        .form-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            height: calc(100vh - 2rem);
            display: flex;
            flex-direction: column;
        }

        .form-header {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-header h1 {
            color: var(--text-color);
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .form-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.3rem;
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--background-color);
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--text-color);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .category-section {
            grid-column: span 2;
            margin-bottom: 0;
            max-width: 400px;
        }

        .category-section select {
            width: 100%;
            max-width: 400px;
        }

        .attributes-container {
            grid-column: span 4;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .attribute-group {
            display: inline-block;
            min-width: 250px;
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            vertical-align: top;
        }

        .attribute-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .attribute-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .attribute-group select,
        .attribute-group input {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--background-color);
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .attribute-group select:focus,
        .attribute-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        .attribute-group select option {
            background: var(--background-color);
            color: var(--text-color);
        }

        .attribute-group.required label::after {
            content: " *";
            color: #ef4444;
        }

        .image-section {
            grid-column: span 4;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .image-upload {
            border: 3px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            background: rgba(108, 92, 231, 0.05);
            position: relative;
        }

        .image-upload input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .image-upload:hover {
            border-color: var(--primary-color);
            background: rgba(108, 92, 231, 0.1);
        }

        .upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            fill: var(--primary-color);
            opacity: 0.8;
            transition: var(--transition);
        }

        .image-upload:hover .upload-icon {
            transform: scale(1.1);
            opacity: 1;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            min-height: 200px;
            direction: ltr !important;
        }

        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 2px solid var(--border-color);
            background: rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .preview-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .preview-item .position-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.2rem 0.4rem;
            text-align: center;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 2;
        }

        .preview-item .preview-actions {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 2;
        }

        .preview-item .remove-btn,
        .preview-item .edit-btn {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
        }

        .preview-item .remove-btn {
            top: 5px;
            left: 5px;
            background: rgba(220, 38, 38, 0.9);
        }

        .preview-item .edit-btn {
            top: 5px;
            right: 5px;
            background: rgba(34, 139, 34, 0.8);
        }

        .preview-item .edit-btn:hover {
            background: rgba(34, 139, 34, 1);
            transform: scale(1.15);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        .preview-item .remove-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.15);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        .sortable-ghost {
            opacity: 0.5;
            transform: scale(1.05);
            border-color: var(--primary-color);
        }

        .sortable-drag {
            opacity: 0.8;
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .submit-row {
            display: flex;
            justify-content: flex-start;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .submit-btn {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.2), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .errorlist {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            list-style: none;
            padding: 0;
        }

        .messages {
            list-style: none;
            padding: 0;
            margin-bottom: 1rem;
        }

        .messages li {
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }

        .messages .success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .messages .error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .messages .warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .specs-section {
            grid-column: span 4;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .specs-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            max-height: 200px;
            overflow-y: auto;
        }

        .spec-item {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }

        .spec-item input {
            flex: 1;
            padding: 0.4rem;
        }

        .add-spec {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .add-spec:hover {
            color: var(--secondary-color);
        }

        .remove-spec {
            background: none;
            border: none;
            color: #ff7675;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.2rem;
            transition: var(--transition);
        }

        .remove-spec:hover {
            color: #d63031;
        }

        .error {
            border-color: #ff7675 !important;
            animation: shake 0.5s ease-in-out;
        }

        .error-message {
            color: #ff7675;
            font-size: 0.8rem;
            margin-top: 0.3rem;
            display: none;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @media (max-width: 1200px) {
            .category-section {
                grid-column: span 2;
            }
            
            .attributes-container {
                grid-column: span 4;
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .category-section {
                grid-column: span 2;
            }
            
            .attributes-container {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .submit-row {
                flex-direction: column;
            }
            .attribute-group {
                width: 200px;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
            border-radius: var(--border-radius);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--border-radius);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .language-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            z-index: 1000;
        }

        body[dir="rtl"] .language-toggle {
            left: auto;
            right: 20px;
        }

        .language-toggle:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .language-toggle img {
            width: 20px;
            height: 20px;
        }

        /* Add styles for tag selector */
        .tag-section {
            grid-column: span 2;
            margin-bottom: 0;
            max-width: 400px;
        }
        
        .multi-select-tags {
            width: 100%;
            min-height: 100px !important;
        }
        
        /* Select2 custom styling */
        .select2-container--default .select2-selection--multiple {
            background-color: rgba(0, 0, 0, 0.2) !important;
            border: 2px solid var(--border-color) !important;
            border-radius: var(--border-radius) !important;
            min-height: 100px !important;
            height: auto !important;
        }
        
        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            min-height: 100px !important;
            height: auto !important;
            padding: 8px !important;
            display: block !important;
        }
        
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: var(--primary-color) !important;
            color: white !important;
            border: none !important;
            border-radius: 20px !important;
            padding: 4px 10px !important;
            margin: 5px !important;
            font-size: 0.9rem !important;
        }
        
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white !important;
            margin-right: 5px !important;
        }
        
        .select2-dropdown {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        .select2-search__field {
            background-color: rgba(0, 0, 0, 0.3) !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
            width: 100% !important;
        }
        
        .select2-results__option {
            color: var(--text-color) !important;
            padding: 8px 12px !important;
        }
        
        .select2-results__option--highlighted {
            background-color: var(--primary-color) !important;
        }

        /* Additional tag field styling */
        .tag-item {
            font-weight: 500;
            display: inline-block;
            padding: 2px 0;
        }

        /* Make the select2 container look better */
        .select2-container {
            max-width: 100%;
            box-shadow: var(--shadow-sm);
        }

        /* Improve dropdown styling */
        .tag-dropdown {
            padding: 8px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            max-height: 300px;
            overflow-y: auto;
        }

        /* Improve the selected tags appearance */
        .select2-container--default .select2-selection--multiple {
            overflow: hidden;
            overflow-y: auto;
            padding: 4px;
        }

        /* Better placeholder styling */
        .select2-container--default .select2-selection--multiple .select2-selection__placeholder {
            color: var(--text-light);
            padding: 5px;
            display: inline-block;
        }

        /* Fix for RTL layout */
        .select2-container--default[dir="rtl"] .select2-selection--multiple .select2-selection__choice {
            float: right;
        }

        /* Styles for attribute selects */
        .attribute-group select.form-control {
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px 12px;
            transition: var(--transition);
        }

        .attribute-group select.form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        .attribute-group select.form-control option {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 8px;
        }

        /* Required field indicator */
        .attribute-group.required label:after {
            content: " *";
            color: #ef4444;
            font-weight: bold;
        }

        /* Edit buttons on image previews */
        .preview-item {
            position: relative;
            margin-right: 10px;
            margin-bottom: 10px;
            width: 150px;
            height: 150px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            border: 2px solid var(--border-color);
        }

        .preview-item.primary-image {
            border-color: var(--primary-color);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .preview-item button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .preview-item button:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }

        /* Add theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            z-index: 1000;
        }

        .theme-toggle:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .theme-toggle i {
            font-size: 1.2rem;
        }

        /* Add these styles for image preview */
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .preview-item {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .preview-item .edit-image {
            right: 35px;
        }

        /* Add crop modal styles */
        .crop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .crop-modal.active {
            display: flex;
        }

        .crop-modal-content {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .crop-container {
            width: 100%;
            height: 600px;
            overflow: hidden;
            border-radius: var(--border-radius);
            background: rgba(0, 0, 0, 0.2);
        }

        .crop-container img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
        }

        .crop-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            padding-top: 0.5rem;
        }

        .crop-save-btn, .crop-cancel-btn {
            padding: 0.3rem 0.8rem;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .crop-save-btn {
            background: var(--primary-color);
            color: rgb(251, 251, 251);
        }

        .crop-cancel-btn {
            background: var(--border-color);
            color: rgb(208, 184, 0);
        }

        .crop-save-btn:hover, .crop-cancel-btn:hover {
            transform: translateY(-2px);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .crop-modal-content {
                width: 95%;
                padding: 0.8rem;
            }
            
            .crop-container {
                height: 162px;
            }
            
            .crop-container img {
                max-height: 162px;
            }
        }

        /* Switch styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
            z-index: 1;
            cursor: pointer;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .status-text {
            margin-right: 15px;
            font-size: 14px;
            color: #6c757d;
            display: inline-block;
            vertical-align: middle;
        }

        .status-text.active {
            color: #28a745;
        }

        .status-text.inactive {
            color: #dc3545;
        }

        /* Add these new styles */
        .form-section {
            grid-column: span 4;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .section-title {
            color: var(--text-color);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .section-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-section .form-group {
            margin-bottom: 0;
        }

        .form-section .category-section,
        .form-section .tag-section {
            grid-column: span 2;
        }

        .form-section .image-section {
            grid-column: span 4;
        }

        .form-section .specs-section {
            grid-column: span 4;
        }

        .form-section .attributes-container {
            grid-column: span 4;
        }

        @media (max-width: 768px) {
            .section-content {
                grid-template-columns: 1fr;
            }

            .form-section .category-section,
            .form-section .tag-section {
                grid-column: span 1;
            }
        }
        /* Button styles moved to earlier section to avoid duplication */
        .preview-item {
            position: relative;
            display: inline-block;
            margin: 5px;
        }

        /* Product Variants Styles */
        .variants-toggle {
            display: flex;
            align-items: center;
            margin-right: auto;
        }
        
        /* Ensure the toggle is visible and clickable */
        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
        }
        
        .toggle-label input[type="checkbox"] {
            margin-left: 8px;
            transform: scale(1.2);
        }
        
        .toggle-switch {
            margin-left: 8px;
            width: 40px;
            height: 20px;
            background: #ccc;
            border-radius: 10px;
            position: relative;
            transition: background 0.3s;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-label input[type="checkbox"]:checked + .toggle-switch {
            background: #007bff;
        }
        
        .toggle-label input[type="checkbox"]:checked + .toggle-switch::after {
            transform: translateX(20px);
        }

        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            gap: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            background-color: var(--border-color);
            border-radius: 12px;
            transition: var(--transition);
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: var(--transition);
        }

        #has_variants:checked + .toggle-switch {
            background-color: var(--primary-color);
        }

        #has_variants:checked + .toggle-switch::before {
            transform: translateX(26px);
        }

        #has_variants {
            display: none;
        }

        .variant-attributes-selection {
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--background-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .variant-attributes-selection h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .variant-attributes-selection .description {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .variant-attributes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .variant-attribute-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
            cursor: pointer;
        }

        .variant-attribute-item:hover {
            border-color: var(--primary-light);
        }

        .variant-attribute-item.selected {
            border-color: var(--primary-color);
            background: rgba(124, 58, 237, 0.1);
        }

        .variant-attribute-item input[type="checkbox"] {
            width: auto;
            margin-left: 0.5rem;
        }

        .variant-attribute-info {
            flex: 1;
        }

        .variant-attribute-name {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .variant-attribute-values {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .variant-generator {
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--background-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .generator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .generator-header h3 {
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .generator-preview {
            margin-top: 1rem;
        }

        .preview-combinations {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .preview-combination {
            padding: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .variants-management {
            margin-bottom: 2rem;
        }

        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .management-header h3 {
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .management-actions {
            display: flex;
            gap: 0.5rem;
        }

        .variants-table-container {
            background: var(--background-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .variants-table {
            width: 100%;
            border-collapse: collapse;
        }

        .variants-table th,
        .variants-table td {
            padding: 0.75rem;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        .variants-table th {
            background: var(--card-bg);
            color: var(--text-color);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .variants-table td {
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .variants-table tbody tr:hover {
            background: rgba(124, 58, 237, 0.05);
        }

        .variant-attributes-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .variant-attribute-badge {
            padding: 0.25rem 0.5rem;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .variant-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-active .status-indicator {
            background: #10b981;
        }

        .status-inactive .status-indicator {
            background: #ef4444;
        }

        .variant-actions {
            display: flex;
            gap: 0.25rem;
        }

        .variant-action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .edit-variant-btn {
            background: var(--primary-color);
            color: white;
        }

        .delete-variant-btn {
            background: #ef4444;
            color: white;
        }

        .variant-action-btn:hover {
            opacity: 0.8;
        }

        /* Variant Modal Styles */
        .variant-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .variant-modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .variant-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .variant-modal-header h3 {
            color: var(--text-color);
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: var(--text-color);
        }

        .variant-modal-body {
            padding: 1rem;
        }

        .variant-modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .variant-attributes {
            margin-bottom: 1rem;
        }

        .variant-attribute-input {
            margin-bottom: 0.75rem;
        }

        .variant-images {
            margin-top: 1rem;
        }

        .variant-image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .variant-image-item {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .variant-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .remove-variant-image {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
        }

        .btn-secondary {
            background: var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background: var(--text-secondary);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .form-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .variant-attributes-grid {
                grid-template-columns: 1fr;
            }
            
            .preview-combinations {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .management-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            .management-actions {
                justify-content: stretch;
            }
            
            .management-actions .btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle" onclick="return toggleTheme();">
        <i>üåì</i>
        <span>ÿ™ÿ∫€å€åÿ± ÿ™ŸÖ</span>
    </button>

    <button class="language-toggle" id="languageToggle" onclick="return toggleLanguage();">
        <img src="{% static 'shop/images/en-flag.png' %}" alt="English" class="en-flag">
        <span>English</span>
    </button>

    <div class="container">
        <div class="form-card">
            <div class="form-header">
                <h1>{% if is_edit %}{{ title }}{% else %}ÿßŸÅÿ≤ŸàÿØŸÜ ŸÖÿ≠ÿµŸàŸÑ ÿ¨ÿØ€åÿØ{% endif %}</h1>
                <div class="header-actions">
                    <input type="submit" value="ÿ∞ÿÆ€åÿ±Ÿá Ÿæ€åÿ¥‚ÄåŸÜŸà€åÿ≥" name="_save" class="submit-btn">
                    <input type="submit" value="Ÿæ€åÿ¥‚ÄåŸÜŸÖÿß€åÿ¥" name="_preview" class="submit-btn">
                    <input type="submit" value="ÿßŸÜÿ™ÿ¥ÿßÿ±" name="_continue" class="submit-btn">
                </div>
            </div>

            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if form.errors %}
            <div class="error-summary">
                {{ form.non_field_errors }}
                {% for field in form %}
                    {% for error in field.errors %}
                        <div class="alert alert-error">
                            {{ field.label }}: {{ error }}
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <script>
            // Simple fallback function for variant data
            window.addVariantDataToForm = window.addVariantDataToForm || function() {
                console.log('üîç addVariantDataToForm fallback called');
                try {
                    if (typeof variantState !== 'undefined' && variantState && variantState.isEnabled && variantState.variants && variantState.variants.length > 0) {
                        const form = document.getElementById('product_form');
                        if (form) {
                            // Remove existing variant inputs
                            const existingInputs = form.querySelectorAll('input[name="variants_data"]');
                            existingInputs.forEach(input => input.remove());
                            
                            // Add variant data
                            const variantDataInput = document.createElement('input');
                            variantDataInput.type = 'hidden';
                            variantDataInput.name = 'variants_data';
                            variantDataInput.value = JSON.stringify(variantState.variants);
                            form.appendChild(variantDataInput);
                            
                            console.log('‚úÖ Fallback: Added variants_data input');
                        }
                    } else {
                        console.log('üîç No variants to add - variantState:', variantState);
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è Fallback addVariantDataToForm error:', e);
                }
            };

            // Test function to manually add variant data
            window.testAddVariantData = function() {
                console.log('üß™ TESTING: Adding variant data manually...');
                const form = document.getElementById('product_form');
                if (form) {
                    // Remove existing variant inputs
                    const existingInputs = form.querySelectorAll('input[name="variants_data"]');
                    existingInputs.forEach(input => input.remove());
                    
                    // Create test variant data
                    const testVariants = [{
                        id: Date.now(),
                        sku: 'TEST-SKU-' + Date.now(),
                        attributes: {
                            'ÿ±ŸÜ⁄Ø': 'ŸÇÿ±ŸÖÿ≤',
                            'ÿ≥ÿß€åÿ≤': 'M'
                        },
                        priceToman: '150000',
                        stock: 10,
                        isActive: true
                    }];
                    
                    // Add variant data
                    const variantDataInput = document.createElement('input');
                    variantDataInput.type = 'hidden';
                    variantDataInput.name = 'variants_data';
                    variantDataInput.value = JSON.stringify(testVariants);
                    form.appendChild(variantDataInput);
                    
                    console.log('‚úÖ TEST: Added test variant data:', variantDataInput.value);
                    
                    // Verify it was added
                    const checkInput = form.querySelector('input[name="variants_data"]');
                    console.log('‚úÖ TEST: Verification - input found:', !!checkInput);
                    if (checkInput) {
                        console.log('‚úÖ TEST: Verification - value:', checkInput.value);
                    }
                }
            };

            // Test form submission
            window.testFormSubmission = function() {
                console.log('üß™ TESTING: Form submission...');
                
                // Add test variant data first
                testAddVariantData();
                
                // Wait a bit then submit
                setTimeout(() => {
                    const form = document.getElementById('product_form');
                    console.log('üß™ Submitting form...');
                    form.submit();
                }, 500);
            };

            // Add custom variant function
            window.addCustomVariant = function() {
                console.log('üé® Adding custom variant...');
                
                // Get user input for custom variant
                const sku = prompt('Enter SKU for your custom variant:');
                if (!sku) return;
                
                const color = prompt('Enter color (or leave empty):');
                const size = prompt('Enter size (or leave empty):');
                const material = prompt('Enter material (or leave empty):');
                const price = prompt('Enter price (or leave empty for 150000):') || '150000';
                const stock = prompt('Enter stock (or leave empty for 10):') || '10';
                
                // Create custom variant
                const customVariant = {
                    id: Date.now(),
                    sku: sku,
                    attributes: {
                        'ÿ±ŸÜ⁄Ø': color || '',
                        'ÿ≥ÿß€åÿ≤': size || '',
                        'ÿ¨ŸÜÿ≥': material || ''
                    },
                    priceToman: price,
                    stock: parseInt(stock),
                    isActive: true
                };
                
                console.log('üé® Created custom variant:', customVariant);
                
                // Add to variantState
                if (typeof variantState !== 'undefined') {
                    if (!variantState.variants) {
                        variantState.variants = [];
                    }
                    variantState.variants.push(customVariant);
                    variantState.isEnabled = true;
                    console.log('‚úÖ Added to variantState. Total variants:', variantState.variants.length);
                }
                
                // Add to variants table
                const variantsTable = document.getElementById('variantsTableBody');
                if (variantsTable) {
                    const row = document.createElement('tr');
                    
                    let attributesText = '';
                    if (color) attributesText += 'ÿ±ŸÜ⁄Ø: ' + color + ' ';
                    if (size) attributesText += 'ÿ≥ÿß€åÿ≤: ' + size + ' ';
                    if (material) attributesText += 'ÿ¨ŸÜÿ≥: ' + material + ' ';
                    
                    row.innerHTML = 
                        '<td>' + sku + '</td>' +
                        '<td>' + attributesText + '</td>' +
                        '<td>' + parseInt(price).toLocaleString() + ' ÿ™ŸàŸÖÿßŸÜ</td>' +
                        '<td>' + stock + '</td>' +
                        '<td>ŸÅÿπÿßŸÑ</td>' +
                        '<td><button onclick="this.closest(\'tr\').remove()">ÿ≠ÿ∞ŸÅ</button></td>';
                    
                    variantsTable.appendChild(row);
                    console.log('‚úÖ Added to variants table');
                }
                
                alert('‚úÖ Custom variant added successfully!');
            };

            // Open variant modal for adding new variant
            window.openVariantModalForAdd = function() {
                console.log('üéØ Opening variant modal for adding...');
                
                const variantModal = document.getElementById('variantModal');
                if (!modal) {
                    console.error('‚ùå Variant modal not found!');
                    alert('ÿÆÿ∑ÿß: ŸÖŸàÿØÿßŸÑ ÿßŸÜŸàÿßÿπ ŸÖÿ≠ÿµŸàŸÑ €åÿßŸÅÿ™ ŸÜÿ¥ÿØ');
                    return;
                }
                
                // Clear the form
                const form = document.getElementById('variantForm');
                if (form) {
                    form.reset();
                }
                
                // Clear variant index (indicating new variant)
                const indexInput = document.getElementById('variantIndex');
                if (indexInput) {
                    indexInput.value = '';
                }
                
                // Set modal title
                const titleElement = document.getElementById('variantModalTitle');
                if (titleElement) {
                    titleElement.textContent = 'ÿßŸÅÿ≤ŸàÿØŸÜ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ¨ÿØ€åÿØ';
                }
                
                // Generate dynamic attribute inputs based on selected category attributes
                generateVariantAttributeInputs();
                
                // Show the modal
                modal.style.display = 'flex';
                console.log('‚úÖ Variant modal opened for adding');
                
                // Focus on SKU input
                const skuInput = document.getElementById('variantSku');
                if (skuInput) {
                    skuInput.focus();
                }
            };

            // Generate dynamic attribute inputs for variant modal
            window.generateVariantAttributeInputs = function() {
                console.log('üîß Generating variant attribute inputs...');
                
                const attributesForm = document.getElementById('variantAttributesForm');
                if (!attributesForm) {
                    console.error('‚ùå variantAttributesForm not found!');
                    return;
                }
                
                // Get the current category ID
                const categorySelect = document.getElementById('id_category');
                const categoryId = categorySelect ? categorySelect.value : null;
                
                if (!categoryId) {
                    attributesForm.innerHTML = `
                        <div class="form-group">
                            <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                                ÿßÿ®ÿ™ÿØÿß ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å ŸÖÿ≠ÿµŸàŸÑ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ
                            </p>
                        </div>
                    `;
                    return;
                }
                
                // Get ONLY the selected attributes from the variant attributes grid
                const selectedAttributes = [];
                const variantAttributesGrid = document.getElementById('variantAttributesGrid');
                
                if (variantAttributesGrid) {
                    // Find all checked checkboxes in the variant attributes grid
                    const checkedBoxes = variantAttributesGrid.querySelectorAll('input[type="checkbox"]:checked');
                    console.log('üîß Found checked attribute boxes:', checkedBoxes.length);
                    
                    checkedBoxes.forEach(checkbox => {
                        const attributeKey = checkbox.value;
                        console.log('üîß Processing checked attribute:', attributeKey);
                        
                        // Find the corresponding attribute data
                        const categoryAttributesData = window.categoryAttributes[categoryId] || window.categoryAttributes[parseInt(categoryId)] || [];
                        const attributeData = categoryAttributesData.find(attr => attr.key === attributeKey);
                        
                        if (attributeData) {
                            selectedAttributes.push(attributeData);
                            console.log('üîß Added selected attribute:', attributeData);
                        }
                    });
                }
                
                console.log('üîß Selected attributes for variant form:', selectedAttributes);
                
                if (selectedAttributes.length === 0) {
                    attributesForm.innerHTML = `
                        <div class="form-group">
                            <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                                ÿßÿ®ÿ™ÿØÿß Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÖŸàÿ±ÿØ ŸÜÿ∏ÿ± ÿ±ÿß ÿßÿ≤ ÿ®ÿßŸÑÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ
                            </p>
                        </div>
                    `;
                    return;
                }
                
                // Generate inputs for each selected attribute
                let html = '';
                selectedAttributes.forEach(attr => {
                    console.log('üîß Generating input for attribute:', attr);
                    
                    if (attr.type === 'select' && attr.values && attr.values.length > 0) {
                        html += `
                            <div class="form-group">
                                <label for="variant_attr_${attr.key}">${attr.key}</label>
                                <select id="variant_attr_${attr.key}" name="variant_attr_${attr.key}" class="form-control">
                                    <option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>
                        `;
                        
                        attr.values.forEach(value => {
                            html += `<option value="${value}">${value}</option>`;
                        });
                        
                        html += `
                                </select>
                            </div>
                        `;
                    } else if (attr.type === 'multiselect' && attr.values && attr.values.length > 0) {
                        html += `
                            <div class="form-group">
                                <label for="variant_attr_${attr.key}">${attr.key}</label>
                                <select id="variant_attr_${attr.key}" name="variant_attr_${attr.key}" class="form-control" multiple>
                        `;
                        
                        attr.values.forEach(value => {
                            html += `<option value="${value}">${value}</option>`;
                        });
                        
                        html += `
                                </select>
                                <small class="form-text">ÿ®ÿ±ÿß€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄ÜŸÜÿØ ⁄Øÿ≤€åŸÜŸáÿå Ctrl ÿ±ÿß ŸÜ⁄ØŸá ÿØÿßÿ±€åÿØ</small>
                            </div>
                        `;
                    }
                });
                
                attributesForm.innerHTML = html;
                console.log('‚úÖ Variant attribute inputs generated');
            };

            // Toggle variants section function
            window.toggleVariantsSection = function(checkbox) {
                console.log('üîÑ toggleVariantsSection called with checkbox:', checkbox);
                console.log('üîÑ Checkbox checked:', checkbox.checked);
                
                const content = document.getElementById('variants-content');
                if (content) {
                    content.style.display = checkbox.checked ? 'block' : 'none';
                    console.log('‚úÖ Variants content display set to:', content.style.display);
                    
                    // Initialize variants management section visibility
                    const variantsManagement = document.getElementById('variantsManagement');
                    if (variantsManagement) {
                        // Check if any attributes are selected
                        const selectedCount = document.querySelectorAll('.variant-attribute-item.selected').length;
                        if (selectedCount > 0) {
                            variantsManagement.style.display = 'block';
                            console.log('‚úÖ Showing variants management (attributes selected)');
                        } else {
                            variantsManagement.style.display = 'none';
                            console.log('‚ùå Hiding variants management (no attributes selected)');
                        }
                    }
                } else {
                    console.log('‚ùå variants-content element not found!');
                }
            };

        // Test load attributes function
        window.testLoadAttributes = function() {
            console.log('üß™ ===========================================');
            console.log('üß™ TESTING LOAD ATTRIBUTES');
            console.log('üß™ ===========================================');
            
            const categorySelect = document.getElementById('id_category');
            const categoryId = categorySelect ? categorySelect.value : null;
            
            console.log('üß™ Category ID:', categoryId);
            console.log('üß™ window.categoryAttributes:', window.categoryAttributes);
            console.log('üß™ typeof window.categoryAttributes:', typeof window.categoryAttributes);
            console.log('üß™ Object.keys(window.categoryAttributes):', Object.keys(window.categoryAttributes));
            
            if (categoryId && window.categoryAttributes[categoryId]) {
                console.log('üß™ Attributes for category', categoryId, ':', window.categoryAttributes[categoryId]);
            } else {
                console.log('üß™ No attributes found for category', categoryId);
            }
            
            // Try to call loadCategoryAttributes manually
            if (typeof loadCategoryAttributes === 'function') {
                console.log('üß™ Calling loadCategoryAttributes manually...');
                window.loadCategoryAttributes(categoryId);
            } else {
                console.log('‚ùå loadCategoryAttributes function not found!');
            }
            
            console.log('üß™ ===========================================');
        };

        // Debug variant form function
        window.debugVariantForm = function() {
            console.log('üîç ===========================================');
            console.log('üîç DEBUGGING VARIANT FORM');
            console.log('üîç ===========================================');
            
            // Check if modal is open
            const variantModal = document.getElementById('variantModal');
            console.log('üîç Modal display:', modal ? modal.style.display : 'Modal not found');
            
            // Check all variant form inputs
            const skuInput = document.getElementById('variantSku');
            const priceInput = document.getElementById('variantPriceToman');
            const stockInput = document.getElementById('variantStock');
            
            console.log('üîç SKU input:', skuInput ? skuInput.value : 'Not found');
            console.log('üîç Price input:', priceInput ? priceInput.value : 'Not found');
            console.log('üîç Stock input:', stockInput ? stockInput.value : 'Not found');
            
            // Check all dynamic attribute inputs
            const categorySelect = document.getElementById('id_category');
            const categoryId = categorySelect ? categorySelect.value : null;
            console.log('üîç Category ID:', categoryId);
            
            if (categoryId) {
                const variantAttributesGrid = document.getElementById('variantAttributesGrid');
                if (variantAttributesGrid) {
                    const checkedBoxes = variantAttributesGrid.querySelectorAll('input[type="checkbox"]:checked');
                    console.log('üîç Checked attributes:', checkedBoxes.length);
                    
                    checkedBoxes.forEach((checkbox, index) => {
                        const attributeKey = checkbox.value;
                        console.log(`üîç Attribute ${index + 1}:`, attributeKey);
                        
                        const input = document.getElementById(`variant_attr_${attributeKey}`);
                        if (input) {
                            console.log(`üîç Input for ${attributeKey}:`, input.value);
                            console.log(`üîç Input type:`, input.type);
                            console.log(`üîç Input options:`, input.options ? input.options.length : 'N/A');
                            
                            if (input.type === 'select-one' && input.selectedOptions) {
                                console.log(`üîç Selected option:`, input.selectedOptions[0] ? input.selectedOptions[0].value : 'None');
                            }
                        } else {
                            console.log(`‚ùå Input for ${attributeKey} not found!`);
                        }
                    });
                }
            }
            
            console.log('üîç ===========================================');
        };

        // Check variant data function
        window.checkVariantData = function() {
                console.log('üîç CHECKING VARIANT DATA...');
                
                // Check variants table
                const variantsTable = document.getElementById('variantsTableBody');
                console.log('üîç Variants table:', variantsTable);
                console.log('üîç Variants table children:', variantsTable ? variantsTable.children.length : 'N/A');
                
                if (variantsTable && variantsTable.children.length > 0) {
                    console.log('üîç Found variants in table:');
                    Array.from(variantsTable.children).forEach((row, index) => {
                        const cells = row.cells;
                        if (cells.length >= 4) {
                            const sku = cells[0].textContent.trim();
                            const attributes = cells[1].textContent.trim();
                            const price = cells[2].textContent.trim();
                            const stock = cells[3].textContent.trim();
                            console.log(`  Variant ${index + 1}: SKU="${sku}", Attributes="${attributes}", Price="${price}", Stock="${stock}"`);
                        }
                    });
                } else {
                    console.log('‚ùå No variants found in table');
                }
                
                // Check variantState
                if (typeof variantState !== 'undefined') {
                    console.log('üîç variantState:', variantState);
                    console.log('üîç variantState.isEnabled:', variantState.isEnabled);
                    console.log('üîç variantState.variants:', variantState.variants);
                    console.log('üîç variantState.variants.length:', variantState.variants ? variantState.variants.length : 'N/A');
                } else {
                    console.log('‚ùå variantState is not defined');
                }
                
                // Check form for variant data input
                const form = document.getElementById('product_form');
                const variantInput = form.querySelector('input[name="variants_data"]');
                console.log('üîç Variant data input in form:', !!variantInput);
                if (variantInput) {
                    console.log('üîç Variant data value:', variantInput.value);
                    try {
                        const parsed = JSON.parse(variantInput.value);
                        console.log('üîç Parsed variant data:', parsed);
                    } catch (e) {
                        console.log('‚ùå Error parsing variant data:', e);
                    }
                }
                
                // Simulate what handleSaveClick would do
                console.log('üîç Simulating handleSaveClick logic...');
                const userCreatedVariants = [];
                
                if (variantsTable && variantsTable.children.length > 0) {
                    Array.from(variantsTable.children).forEach((row, index) => {
                        const cells = row.cells;
                        if (cells.length >= 4) {
                            const sku = cells[0].textContent.trim();
                            const attributesText = cells[1].textContent.trim();
                            const priceText = cells[2].textContent.trim();
                            const stockText = cells[3].textContent.trim();
                            
                            const attributes = {};
                            if (attributesText) {
                                const attrParts = attributesText.split(' ');
                                attrParts.forEach(part => {
                                    if (part.includes('ÿ±ŸÜ⁄Ø:')) {
                                        attributes['ÿ±ŸÜ⁄Ø'] = part.replace('ÿ±ŸÜ⁄Ø:', '').trim();
                                    } else if (part.includes('ÿ≥ÿß€åÿ≤:')) {
                                        attributes['ÿ≥ÿß€åÿ≤'] = part.replace('ÿ≥ÿß€åÿ≤:', '').trim();
                                    } else if (part.includes('ÿ¨ŸÜÿ≥:')) {
                                        attributes['ÿ¨ŸÜÿ≥'] = part.replace('ÿ¨ŸÜÿ≥:', '').trim();
                                    }
                                });
                            }
                            
                            const variant = {
                                id: Date.now() + index,
                                sku: sku,
                                attributes: attributes,
                                priceToman: priceText.replace(/[^\d]/g, '') || '0',
                                stock: parseInt(stockText) || 0,
                                isActive: true
                            };
                            
                            userCreatedVariants.push(variant);
                        }
                    });
                }
                
                console.log('üîç User created variants that would be sent:', userCreatedVariants);
                
                if (userCreatedVariants.length > 0) {
                    console.log('‚úÖ Variants would be sent to backend');
                } else {
                    console.log('‚ùå No variants would be sent to backend');
                }
            };

            // Handle save button click
            window.handleSaveClick = function() {
                console.log('üñ±Ô∏è SAVE BUTTON CLICKED!');
                console.log('üîç ===========================================');
                console.log('üîç STARTING VARIANT EXTRACTION PROCESS');
                console.log('üîç ===========================================');
                
                // First, check if there are any variants in the table (user-created variants)
                const variantsTable = document.getElementById('variantsTableBody');
                const userCreatedVariants = [];
                
                console.log('üîç Checking variants table:', variantsTable);
                console.log('üîç Variants table children:', variantsTable ? variantsTable.children.length : 'N/A');
                
                if (variantsTable && variantsTable.children.length > 0) {
                    console.log('üîç Found user-created variants in table:', variantsTable.children.length);
                    console.log('üîç ===========================================');
                    console.log('üîç EXTRACTING VARIANTS FROM TABLE');
                    console.log('üîç ===========================================');
                    
                    // Extract variants from the table
                    Array.from(variantsTable.children).forEach((row, index) => {
                        const cells = row.cells;
                        console.log(`üîç Processing row ${index + 1}, cells count:`, cells.length);
                        if (cells.length >= 4) {
                            const sku = cells[0].textContent.trim();
                            const attributesText = cells[1].textContent.trim();
                            const priceText = cells[2].textContent.trim();
                            const stockText = cells[3].textContent.trim();
                            
                            console.log(`üîç Row ${index + 1} data:`, { 
                                sku, 
                                attributesText, 
                                priceText, 
                                stockText 
                            });
                            
                            // Parse attributes from text
                            const attributes = {};
                            if (attributesText) {
                                const attrParts = attributesText.split(' ');
                                attrParts.forEach(part => {
                                    if (part.includes('ÿ±ŸÜ⁄Ø:')) {
                                        attributes['ÿ±ŸÜ⁄Ø'] = part.replace('ÿ±ŸÜ⁄Ø:', '').trim();
                                    } else if (part.includes('ÿ≥ÿß€åÿ≤:')) {
                                        attributes['ÿ≥ÿß€åÿ≤'] = part.replace('ÿ≥ÿß€åÿ≤:', '').trim();
                                    } else if (part.includes('ÿ¨ŸÜÿ≥:')) {
                                        attributes['ÿ¨ŸÜÿ≥'] = part.replace('ÿ¨ŸÜÿ≥:', '').trim();
                                    }
                                });
                            }
                            
                            const variant = {
                                id: Date.now() + index,
                                sku: sku,
                                attributes: attributes,
                                priceToman: priceText.replace(/[^\d]/g, '') || '0',
                                stock: parseInt(stockText) || 0,
                                isActive: true
                            };
                            
                            userCreatedVariants.push(variant);
                            console.log(`üîç ‚úÖ Extracted variant ${index + 1}:`, variant);
                        } else {
                            console.log(`üîç ‚ùå Row ${index + 1} has insufficient cells:`, cells.length);
                        }
                    });
                    
                    console.log('üîç ===========================================');
                    console.log('üîç TOTAL VARIANTS EXTRACTED:', userCreatedVariants.length);
                    console.log('üîç ===========================================');
                } else {
                    console.log('üîç No variants found in table, checking variantState...');
                    if (typeof variantState !== 'undefined') {
                        console.log('üîç variantState.variants:', variantState.variants);
                        console.log('üîç variantState.isEnabled:', variantState.isEnabled);
                        if (variantState.variants && variantState.variants.length > 0) {
                            userCreatedVariants.push(...variantState.variants);
                            console.log('üîç Using variants from variantState:', userCreatedVariants);
                        }
                    }
                }
                
                // Update variantState with user-created variants
                if (userCreatedVariants.length > 0) {
                    console.log('üîç ===========================================');
                    console.log('üîç UPDATING VARIANT STATE');
                    console.log('üîç ===========================================');
                    console.log('‚úÖ Updating variantState with user-created variants:', userCreatedVariants);
                    if (typeof variantState !== 'undefined') {
                        variantState.variants = userCreatedVariants;
                        variantState.isEnabled = true;
                        console.log('‚úÖ variantState updated successfully');
                        console.log('‚úÖ variantState.variants.length:', variantState.variants.length);
                    } else {
                        console.log('‚ùå variantState is not defined!');
                    }
                } else {
                    console.log('üîç No user variants found, will add test data if needed');
                }
                
                console.log('üîç ===========================================');
                console.log('üîç CALLING addVariantDataToForm');
                console.log('üîç ===========================================');
                
                try {
                    if (typeof addVariantDataToForm === 'function') {
                        console.log('üîç Calling addVariantDataToForm...');
                        addVariantDataToForm();
                        console.log('‚úÖ addVariantDataToForm completed');
                    } else {
                        console.log('‚ö†Ô∏è addVariantDataToForm not found, continuing...');
                    }
                } catch(e) {
                    console.log('‚ö†Ô∏è Error calling addVariantDataToForm:', e);
                }
                
                setTimeout(() => {
                    console.log('üîç ===========================================');
                    console.log('üîç FINAL FORM SUBMISSION CHECK');
                    console.log('üîç ===========================================');
                    console.log('üöÄ FORCING FORM SUBMISSION...');
                    const form = document.getElementById('product_form');
                    let variantInput = form.querySelector('input[name="variants_data"]');
                    console.log('üîç Variant input found:', !!variantInput);
                    
                    if (variantInput) {
                        console.log('üîç Variant data value:', variantInput.value);
                        console.log('üîç Variant data value length:', variantInput.value.length);
                        try {
                            const parsed = JSON.parse(variantInput.value);
                            console.log('üîç Parsed variant data:', parsed);
                            console.log('üîç Number of variants being sent:', parsed.length);
                            if (parsed.length > 0) {
                                console.log('üîç First variant attributes:', parsed[0].attributes);
                                console.log('üîç First variant attributes keys:', Object.keys(parsed[0].attributes || {}));
                                console.log('üîç First variant attributes values:', Object.values(parsed[0].attributes || {}));
                            }
                        } catch (e) {
                            console.log('‚ùå Error parsing variant data:', e);
                        }
                    } else {
                        console.log('‚ùå NO VARIANT DATA INPUT FOUND!');
                        // Only add test data if no user variants were found
                        if (userCreatedVariants.length === 0) {
                            console.log('üîç No user variants found, adding test data...');
                            testAddVariantData();
                            variantInput = form.querySelector('input[name="variants_data"]');
                            console.log('üîç After adding test data - variant input found:', !!variantInput);
                            if (variantInput) {
                                console.log('üîç Test variant data value:', variantInput.value);
                            }
                        } else {
                            console.log('üîç User variants found, not adding test data');
                            console.log('‚ùå BUT NO VARIANT INPUT FOUND - THIS IS THE PROBLEM!');
                        }
                    }
                    
                    console.log('üîç ===========================================');
                    console.log('üîç SUBMITTING FORM NOW');
                    console.log('üîç ===========================================');
                    
                    form.submit();
                }, 100);
            };
            </script>

             <form method="post" action="{% url 'suppliers:add_product' %}" enctype="multipart/form-data" id="product_form" novalidate onsubmit="console.log('üì§ FORM ONSUBMIT TRIGGERED!'); if (typeof addVariantDataToForm === 'function') { addVariantDataToForm(); } else { console.log('‚ö†Ô∏è addVariantDataToForm function not found'); } return true;">
                {% csrf_token %}
                {% if is_edit %}
                <input type="hidden" name="is_edit" value="true">
                <input type="hidden" id="product_id" name="product_id" value="{{ product.id }}">
                {% endif %}
                <div class="form-grid">
                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <h2 class="section-title">ÿßÿ∑ŸÑÿßÿπÿßÿ™ Ÿæÿß€åŸá</h2>
                        <div class="section-content">
                            <!-- Product Name -->
                            <div class="form-group">
                                <label for="name">ŸÜÿßŸÖ ŸÖÿ≠ÿµŸàŸÑ</label>
                                <input type="text" id="name" name="name" required {% if product %}value="{{ product.name }}"{% endif %}>
                            </div>

                            <!-- Brand -->
                            <div class="form-group">
                                <label for="brand">ÿ®ÿ±ŸÜÿØ</label>
                                <input type="text" id="brand" name="brand" {% if product %}value="{{ product.brand }}"{% endif %}>
                            </div>

                            <!-- Brand Image Section -->
                            <div class="form-group">
                                <label for="brand_image">ÿ™ÿµŸà€åÿ± ÿ®ÿ±ŸÜÿØ</label>
                                <div class="image-upload">
                                    <input type="file" id="brand_image" name="brand_image" accept="image/*">
                                    <div class="upload-area">
                                        <svg class="upload-icon" viewBox="0 0 24 24">
                                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                        </svg>
                                        <p>ÿ®ÿ±ÿß€å ÿßŸÜÿ™ÿÆÿßÿ® ÿ™ÿµŸà€åÿ± ÿ®ÿ±ŸÜÿØ ⁄©ŸÑ€å⁄© ⁄©ŸÜ€åÿØ</p>
                                        <p class="upload-hint">PNG, JPG ÿ™ÿß 10 ŸÖ⁄Øÿßÿ®ÿß€åÿ™</p>
                                    </div>
                                </div>
                                <div id="brandImagePreview" class="current-image" style="margin-top: 10px;">
                                    {% if product and product.brand_image %}
                                    <img src="{{ product.brand_image.url }}" alt="Brand Image" style="max-width: 200px;">
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="form-group">
                                <label for="description">ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™</label>
                                <textarea id="description" name="description" required>{% if product %}{{ product.description }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Category and Tags Section -->
                    <div class="form-section">
                        <h2 class="section-title">ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å Ÿà ÿ®ÿ±⁄Üÿ≥ÿ®‚ÄåŸáÿß</h2>
                        <div class="section-content">
                            <!-- Category Section -->
                            <div class="form-group category-section">
                                <label for="id_category">{{ form.category.label }}</label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                <div class="error-message">{{ form.category.errors }}</div>
                                {% endif %}
                                <script>
                                    // Category change event listener moved to global scope
                                </script>
                            </div>

                            <!-- Tags Section -->
                            <div class="form-group tag-section">
                                <label for="id_tags">ÿ®ÿ±⁄Üÿ≥ÿ®‚ÄåŸáÿß</label>
                                <select name="tags" id="id_tags" multiple class="form-control multi-select-tags" data-placeholder="ÿßŸÜÿ™ÿÆÿßÿ® ÿ®ÿ±⁄Üÿ≥ÿ®‚ÄåŸáÿß">
                                    <!-- Options will be populated dynamically by JavaScript -->
                                </select>
                                {% if form.tags.errors %}
                                <div class="error-message">{{ form.tags.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">ÿ®ÿ±⁄Üÿ≥ÿ®‚ÄåŸáÿß ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸá ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ</small>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Section -->
                    <div class="form-section">
                        <h2 class="section-title">ŸÇ€åŸÖÿ™‚Äå⁄Øÿ∞ÿßÿ±€å</h2>
                        <div class="section-content">
                            <div class="form-group">
                                <label for="price_toman">ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ) <span class="required">*</span></label>
                                <input type="text" id="price_toman" name="price_toman" step="1" min="0" required {% if product %}value="{{ product.price_toman }}"{% endif %} oninput="formatNumberWithCommas(this)" onblur="formatNumberWithCommas(this)">
                            </div>

                            <div class="form-group">
                                <label for="price_usd">ŸÇ€åŸÖÿ™ (ÿØŸÑÿßÿ±) - ÿßÿÆÿ™€åÿßÿ±€å</label>
                                <input type="text" id="price_usd" name="price_usd" step="0.01" min="0" {% if product %}value="{{ product.price_usd }}"{% endif %} oninput="formatNumberWithCommas(this)" onblur="formatNumberWithCommas(this)">
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Section -->
                    <div class="form-section">
                        <h2 class="section-title">ŸÖŸàÿ¨ŸàÿØ€å Ÿà Ÿàÿ∂ÿπ€åÿ™</h2>
                        <div class="section-content">
                            <div class="form-group">
                                <label for="stock">ÿ™ÿπÿØÿßÿØ ŸÖŸàÿ¨ŸàÿØ€å</label>
                                <input type="number" id="stock" name="stock_quantity" required {% if product %}value="{{ product.stock_quantity }}"{% endif %}>
                            </div>

                            <div class="form-group">
                                <label for="is_active">Ÿàÿ∂ÿπ€åÿ™ ŸÖÿ≠ÿµŸàŸÑ</label>
                                <div class="switch">
                                    <input type="checkbox" id="is_active" name="is_active" {% if not product or product.is_active %}checked{% endif %}>
                                    <span class="slider round"></span>
                                </div>
                                <span class="status-text" id="statusText">ŸÅÿπÿßŸÑ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Product Variants Section -->
                    <div class="form-section" id="variants-section">
                        <h2 class="section-title">
                            ÿßŸÜŸàÿßÿπ ŸÖÿ≠ÿµŸàŸÑ (ÿ±ŸÜ⁄Øÿå ÿ≥ÿß€åÿ≤ Ÿà...)
                            <div class="variants-toggle">
                                <label class="toggle-label">
                                    <input type="checkbox" id="has_variants" name="has_variants" {% if existing_variants %}checked{% endif %} onchange="toggleVariantsSection(this)" onclick="console.log('CHECKBOX CLICKED!'); setTimeout(() => { const content = document.getElementById('variants-content'); if(content) content.style.display = this.checked ? 'block' : 'none'; }, 10);">
                                    <span class="toggle-switch"></span>
                                    ÿß€åŸÜ ŸÖÿ≠ÿµŸàŸÑ ÿßŸÜŸàÿßÿπ ŸÖÿÆÿ™ŸÑŸÅ ÿØÿßÿ±ÿØ
                                </label>
                            </div>
                        </h2>
                        <div class="section-content" id="variants-content" style="display: {% if existing_variants %}block{% else %}none{% endif %};">
                            <!-- DEBUG: Add test button -->
                            <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
                                <button type="button" onclick="testVariantsToggle()" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                                    üß™ Test Variants Toggle
                                </button>
                                <button type="button" onclick="document.getElementById('has_variants').click()" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 10px;">
                                    üîÑ Force Toggle
                                </button>
                                <span id="test-result" style="margin-left: 10px;"></span>
                            </div>
                            
                            <!-- This will be made visible by JavaScript if variants exist -->
                            <!-- Variant Attributes Selection -->
                            <div class="variant-attributes-selection">
                                <h3>ÿßŸÜÿ™ÿÆÿßÿ® Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÖÿ™ÿ∫€åÿ±</h3>
                                <p class="description">Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å€å ⁄©Ÿá ÿ®ÿ±ÿß€å ÿß€åŸÜ ŸÖÿ≠ÿµŸàŸÑ ŸÇÿßÿ®ŸÑ ÿ™ÿ∫€å€åÿ± Ÿáÿ≥ÿ™ŸÜÿØ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ:</p>
                                <div class="variant-attributes-grid" id="variantAttributesGrid">
                                    <div class="variant-attribute-item" onclick="toggleAttributeSelection(this, 'ÿ±ŸÜ⁄Ø')">
                                        <input type="checkbox" id="attr_color">
                                        <div class="variant-attribute-info">
                                            <div class="variant-attribute-name">ÿ±ŸÜ⁄Ø</div>
                                            <div class="variant-attribute-values">ŸÇÿ±ŸÖÿ≤ÿå ÿ¢ÿ®€åÿå ÿ≥ŸÅ€åÿØÿå ÿ≥€åÿßŸáÿå ÿ≥ÿ®ÿ≤</div>
                                        </div>
                                    </div>
                                    <div class="variant-attribute-item" onclick="toggleAttributeSelection(this, 'ÿ≥ÿß€åÿ≤')">
                                        <input type="checkbox" id="attr_size">
                                        <div class="variant-attribute-info">
                                            <div class="variant-attribute-name">ÿ≥ÿß€åÿ≤</div>
                                            <div class="variant-attribute-values">Sÿå Mÿå Lÿå XLÿå 2XL</div>
                                        </div>
                                    </div>
                                    <div class="variant-attribute-item" onclick="toggleAttributeSelection(this, 'ÿ¨ŸÜÿ≥')">
                                        <input type="checkbox" id="attr_material">
                                        <div class="variant-attribute-info">
                                            <div class="variant-attribute-name">ÿ¨ŸÜÿ≥</div>
                                            <div class="variant-attribute-values">ŸæŸÜÿ®Ÿáÿå ŸæŸÑ€å‚Äåÿßÿ≥ÿ™ÿ±ÿå Ÿæÿ¥ŸÖÿå ÿßÿ®ÿ±€åÿ¥ŸÖ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Variant Generator -->
                            <div class="variant-generator" id="variantGenerator">
                                <div class="generator-header">
                                    <h3>ÿ™ŸàŸÑ€åÿØ ÿÆŸàÿØ⁄©ÿßÿ± ÿßŸÜŸàÿßÿπ ŸÖÿ≠ÿµŸàŸÑ</h3>
                                    <button type="button" class="btn btn-primary" id="generateVariants">ÿ™ŸàŸÑ€åÿØ ÿßŸÜŸàÿßÿπ ŸÖÿ≠ÿµŸàŸÑ</button>
                                </div>
                                <div class="generator-preview" id="generatorPreview">
                                    <!-- Preview of combinations will be shown here -->
                                </div>
                            </div>

                            <!-- Variants Management Table -->
                            <div class="variants-management" id="variantsManagement" style="display: none;">
                                <div class="management-header">
                                    <h3>ŸÖÿØ€åÿ±€åÿ™ ÿßŸÜŸàÿßÿπ ŸÖÿ≠ÿµŸàŸÑ</h3>
                                    <div class="management-actions">
                                        <button type="button" class="btn btn-secondary" onclick="openVariantModalForAdd();">+ ÿßŸÅÿ≤ŸàÿØŸÜ ÿØÿ≥ÿ™€å</button>
                                        <button type="button" class="btn btn-warning" id="clearAllVariants">Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ŸáŸÖŸá</button>
                                        <button type="button" class="btn btn-info" onclick="debugVariantForm()">üîç ÿ®ÿ±ÿ±ÿ≥€å ŸÅÿ±ŸÖ</button>
                                        <button type="button" class="btn btn-success" onclick="testLoadAttributes()">üß™ ÿ™ÿ≥ÿ™ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å</button>
                                    </div>
                                </div>
                                <div class="variants-table-container">
                                    <table class="variants-table" id="variantsTable">
                                        <thead>
                                            <tr>
                                                <th>⁄©ÿØ ŸÖÿ≠ÿµŸàŸÑ (SKU)</th>
                                                <th>Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß</th>
                                                <th>ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ)</th>
                                                <th>ŸÖŸàÿ¨ŸàÿØ€å</th>
                                                <th>Ÿàÿ∂ÿπ€åÿ™</th>
                                                <th>ÿπŸÖŸÑ€åÿßÿ™</th>
                                            </tr>
                                        </thead>
                                        <tbody id="variantsTableBody">
                                            <!-- Variant rows will be added here -->
                                            {% if existing_variants %}
                                                {% for variant in existing_variants %}
                                                <tr>
                                                    <td><strong>{{ variant.sku }}</strong></td>
                                                    <td>
                                                        <span class="variant-attribute-badge" style="background: {% if variant.color == 'ŸÇÿ±ŸÖÿ≤' %}#dc3545{% elif variant.color == 'ÿ¢ÿ®€å' %}#007bff{% elif variant.color == 'ÿ≥ÿ®ÿ≤' %}#28a745{% elif variant.color == 'ÿ≤ÿ±ÿØ' %}#ffc107{% elif variant.color == 'ÿ≥€åÿßŸá' %}#343a40{% elif variant.color == 'ÿ≥ŸÅ€åÿØ' %}#6c757d{% elif variant.color == 'ÿµŸàÿ±ÿ™€å' %}#e83e8c{% elif variant.color == 'ŸÜÿßÿ±ŸÜÿ¨€å' %}#fd7e14{% elif variant.color == 'ÿ®ŸÜŸÅÿ¥' %}#6f42c1{% elif variant.color == 'ŸÇŸáŸàŸá‚Äåÿß€å' %}#795548{% else %}#6c757d{% endif %}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">
                                                            {{ variant.color|default:"ŸÜÿßŸÖÿ¥ÿÆÿµ" }}
                                                        </span>
                                                    </td>
                                                    <td>{{ variant.size|default:"ŸÜÿßŸÖÿ¥ÿÆÿµ" }}</td>
                                                    <td>{{ variant.material|default:"ŸÜÿßŸÖÿ¥ÿÆÿµ" }}</td>
                                                    <td>{{ variant.price_toman|floatformat:0|add:" ÿ™ŸàŸÖÿßŸÜ" }}</td>
                                                    <td>{{ variant.stock_quantity }}</td>
                                                    <td class="variant-status {% if variant.is_active %}active{% else %}inactive{% endif %}">
                                                        {% if variant.is_active %}ŸÅÿπÿßŸÑ{% else %}ÿ∫€åÿ±ŸÅÿπÿßŸÑ{% endif %}
                                                    </td>
                                                    <td class="variant-actions">
                                                        <button type="button" class="variant-action-btn edit-variant-btn" onclick="editVariant({{ variant.id }})">Ÿà€åÿ±ÿß€åÿ¥</button>
                                                        <button type="button" class="variant-action-btn delete-variant-btn" onclick="deleteVariant({{ variant.id }})">ÿ≠ÿ∞ŸÅ</button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Variant Form Modal -->
                            <div class="variant-modal" id="variantModal" style="display: none;">
                                <div class="variant-modal-content">
                                    <div class="variant-modal-header">
                                        <h3 id="variantModalTitle">ÿßŸÅÿ≤ŸàÿØŸÜ/Ÿà€åÿ±ÿß€åÿ¥ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ</h3>
                                        <button type="button" class="close-modal" onclick="document.getElementById('variantModal').style.display='none';">&times;</button>
                                    </div>
                                    <div class="variant-modal-body">
                                        <form id="variantForm">
                                            <input type="hidden" id="variantIndex" value="">
                                            
                                            <div class="form-group">
                                                <label for="variantSku">⁄©ÿØ ŸÖÿ≠ÿµŸàŸÑ (SKU)</label>
                                                <div style="display: flex; gap: 0.5rem;">
                                                    <input type="text" id="variantSku" class="form-control" required>
                                                    <button type="button" class="btn btn-secondary" onclick="
var productName = document.getElementById('name').value || 'PRODUCT';
var sku = productName.substring(0, 4).toUpperCase() + '-' + Math.floor(Math.random() * 1000);
document.getElementById('variantSku').value = sku;
alert('SKU ÿ™ŸàŸÑ€åÿØ ÿ¥ÿØ: ' + sku);
" style="white-space: nowrap;">ÿ™ŸàŸÑ€åÿØ ÿÆŸàÿØ⁄©ÿßÿ±</button>
                                                </div>
                                                <small class="form-text">⁄©ÿØ €å⁄©ÿ™ÿß ÿ®ÿ±ÿß€å ÿß€åŸÜ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ</small>
                                            </div>

                                            <div class="variant-attributes" id="variantAttributesForm">
                                                <!-- Dynamic attributes will be loaded here based on selected category -->
                                                <div class="form-group">
                                                    <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                                                        ÿßÿ®ÿ™ÿØÿß ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å ŸÖÿ≠ÿµŸàŸÑ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ ÿ™ÿß Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÖÿ±ÿ®Ÿàÿ∑Ÿá ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ÿ¥ŸàÿØ
                                                    </p>
                                                </div>
                                            </div>

                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label for="variantPriceToman">ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ)</label>
                                                    <input type="text" id="variantPriceToman" class="form-control" oninput="formatNumberWithCommas(this)">
                                                    <small class="form-text">ÿÆÿßŸÑ€å ÿ®⁄Øÿ∞ÿßÿ±€åÿØ ÿ™ÿß ÿßÿ≤ ŸÇ€åŸÖÿ™ ÿßÿµŸÑ€å ŸÖÿ≠ÿµŸàŸÑ ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿ¥ŸàÿØ</small>
                                                </div>
                                                <div class="form-group">
                                                    <label for="variantStock">ŸÖŸàÿ¨ŸàÿØ€å</label>
                                                    <input type="number" id="variantStock" class="form-control" min="0" required>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label>
                                                    <input type="checkbox" id="variantIsActive" checked>
                                                    ŸÅÿπÿßŸÑ
                                                </label>
                                            </div>

                                            <div class="variant-images">
                                                <label>ÿ™ÿµÿßŸà€åÿ± ŸÖÿÆÿµŸàÿµ ÿß€åŸÜ ŸÜŸàÿπ</label>
                                                <input type="file" id="variantImages" multiple accept="image/*">
                                                <div class="variant-image-preview" id="variantImagePreview"></div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="variant-modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('variantModal').style.display='none';">ÿßŸÜÿµÿ±ÿßŸÅ</button>
                                        <button type="button" onclick="saveVariant()" class="btn btn-primary">ÿ∞ÿÆ€åÿ±Ÿá ŸÖÿ≠ÿµŸàŸÑ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Images Section -->
                    <div class="image-section">
                        <label>ÿ™ÿµÿßŸà€åÿ± ŸÖÿ≠ÿµŸàŸÑ</label>
                        <div class="image-upload">
                            <input type="file" id="imageInput" name="images" multiple accept="image/*">
                            <div class="upload-area">
                                <svg class="upload-icon" viewBox="0 0 24 24">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                </svg>
                                <p>ÿ®ÿ±ÿß€å ÿßŸÜÿ™ÿÆÿßÿ® ÿ™ÿµÿßŸà€åÿ± ⁄©ŸÑ€å⁄© ⁄©ŸÜ€åÿØ</p>
                                <p class="upload-hint">PNG, JPG ÿ™ÿß 10 ŸÖ⁄Øÿßÿ®ÿß€åÿ™</p>
                            </div>
                        </div>
                        <div class="image-preview" id="imagePreviews"></div>
                    </div>

                    <!-- Specifications Section -->
                    <div class="form-section">
                        <h2 class="section-title">ŸÖÿ¥ÿÆÿµÿßÿ™ ŸÅŸÜ€å</h2>
                        <div class="section-content">
                            <div class="specs-container" id="specsContainer">
                                <div class="spec-item">
                                    <input type="text" placeholder="⁄©ŸÑ€åÿØ (ŸÖÿ´ÿßŸÑ: ÿ±ŸÜ⁄Ø)" name="spec_key[]">
                                    <input type="text" placeholder="ŸÖŸÇÿØÿßÿ± (ŸÖÿ´ÿßŸÑ: ŸÇÿ±ŸÖÿ≤)" name="spec_value[]">
                                    <button type="button" class="remove-spec">√ó</button>
                                </div>
                            </div>
                            <button type="button" class="add-spec">+ ÿßŸÅÿ≤ŸàÿØŸÜ ŸÖÿ¥ÿÆÿµŸá</button>
                        </div>
                    </div>

                    <!-- Attributes Container -->
                    <div class="form-section">
                        <h2 class="section-title">Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å</h2>
                        <div class="section-content">
                            <div id="attributes-container" class="attributes-container">
                                <!-- Category attributes will be loaded here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="submit-row">
                     <input type="submit" name="_save" value="ÿ∞ÿÆ€åÿ±Ÿá ŸÖÿ≠ÿµŸàŸÑ" class="submit-btn" style="background: #4CAF50; font-size: 16px; padding: 12px 24px;" onclick="handleSaveClick(); return false;">
                     <button type="button" onclick="testAddVariantData()" class="submit-btn" style="background: orange; margin-left: 10px;">ÿ™ÿ≥ÿ™ ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ŸÜŸàÿπ</button>
                     <button type="button" onclick="testFormSubmission()" class="submit-btn" style="background: red; margin-left: 10px;">ÿ™ÿ≥ÿ™ ÿßÿ±ÿ≥ÿßŸÑ ŸÅÿ±ŸÖ</button>
                                <button type="button" onclick="addCustomVariant()" class="submit-btn" style="background: purple; margin-left: 10px;">ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ŸÜŸàÿπ ÿ≥ŸÅÿßÿ±ÿ¥€å</button>
                                <button type="button" onclick="checkVariantData()" class="submit-btn" style="background: brown; margin-left: 10px;">ÿ®ÿ±ÿ±ÿ≥€å ÿØÿßÿØŸá ŸÜŸàÿπ</button>
                                <button type="button" onclick="window.loadCategoryAttributes(1027)" class="submit-btn" style="background: teal; margin-left: 10px;">ÿ™ÿ≥ÿ™ ÿØÿ≥ÿ™Ÿá 1027</button>
                                <button type="button" onclick="console.log('üîç variantState:', variantState); console.log('üîç variantState.variants:', variantState.variants);" class="submit-btn" style="background: pink; margin-left: 10px;">ÿ®ÿ±ÿ±ÿ≥€å variantState</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Crop Modal HTML -->
    <div class="crop-modal">
        <div class="crop-modal-content">
            <div class="crop-container">
                <img id="cropImage" src="" alt="Image to crop">
            </div>
            <div class="crop-controls">
                <button class="crop-cancel-btn">ÿßŸÜÿµÿ±ÿßŸÅ</button>
                <button class="crop-save-btn">ÿ∞ÿÆ€åÿ±Ÿá</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize form
            const form = document.getElementById('product_form');
            const variantToggle = document.getElementById('has_variants');
            const variantContent = document.getElementById('variants-content');
            
            // Setup variant toggle
            if (variantToggle && variantContent) {
                variantToggle.addEventListener('change', function() {
                    variantContent.style.display = this.checked ? 'block' : 'none';
                });
            }
            
            // Initialize variant management
            if (typeof initVariantManagement === 'function') {
                initVariantManagement();
            }
            
             // Handle form submission
             if (form) {
                 form.addEventListener('submit', function(e) {
                     console.log('üì§ Form submission started...');
                     console.log('üì§ Form action:', form.action);
                     console.log('üì§ Form method:', form.method);
                     console.log('üì§ Event target:', e.target);
                     console.log('üì§ Event submitter:', e.submitter);
                     
                     // Add variant data to form if variants are enabled
                     if (variantToggle && variantToggle.checked && typeof addVariantDataToForm === 'function') {
                         console.log('üîÑ Adding variant data to form...');
                         addVariantDataToForm();
                     }
                     
                     // Log form data before submission
                     const formData = new FormData(form);
                     console.log('üìã Form data being submitted:');
                     for (let [key, value] of formData.entries()) {
                         console.log(`  ${key}: ${value}`);
                     }
                     
                     console.log('‚úÖ Form submission proceeding...');
                     console.log('‚úÖ About to submit form to:', form.action);
                     
                     // Don't prevent default - let the form submit normally
                     // e.preventDefault(); // REMOVED THIS LINE
                 });
             }
        });
        
        // Test form submission function
        window.testFormSubmit = function() {
            console.log('üß™ Testing form submission...');
            const form = document.getElementById('product_form');
            if (!form) {
                console.log('‚ùå Form not found!');
                return;
            }

            // Fill required fields
            const nameField = form.querySelector('input[name="name"]');
            const categoryField = form.querySelector('select[name="category"]');
            const priceField = form.querySelector('input[name="price_toman"]');

            if (nameField) nameField.value = 'Test Product ' + new Date().toISOString();
            if (categoryField) categoryField.value = '1036'; // Use a valid category ID
            if (priceField) priceField.value = '100000';

            console.log('‚úÖ Required fields filled:', {
                name: nameField?.value,
                category: categoryField?.value,
                price: priceField?.value
            });

            // Submit the form
            const submitButton = form.querySelector('input[name="_save"]');
            if (submitButton) {
                console.log('üîÑ Clicking save button...');
                submitButton.click();
            } else {
                console.log('‚ùå Save button not found!');
            }
        };

         // Test variant save function
         window.testVariantSave = function() {
             console.log('üß™ TESTING VARIANT SAVE...');
             
             // Check if all required elements exist
             const variantModal = document.getElementById('variantModal');
             const variantForm = document.getElementById('variantForm');
             const variantSku = document.getElementById('variantSku');
             const variantStock = document.getElementById('variantStock');
             
             console.log('üîç variantModal found:', !!variantModal);
             console.log('üîç variantForm found:', !!variantForm);
             console.log('üîç variantSku found:', !!variantSku);
             console.log('üîç variantStock found:', !!variantStock);
             
             if (!variantModal) {
                 console.error('‚ùå variantModal not found!');
                 alert('ÿÆÿ∑ÿß: ŸÖŸàÿØÿßŸÑ ÿßŸÜŸàÿßÿπ ŸÖÿ≠ÿµŸàŸÑ €åÿßŸÅÿ™ ŸÜÿ¥ÿØ');
                 return;
             }
             
             // Check if variantState exists
             if (typeof variantState === 'undefined') {
                 console.log('‚ùå variantState is not defined!');
                 return;
             }
             
             console.log('‚úÖ variantState found:', variantState);
             console.log('‚úÖ Current variants count:', variantState.variants?.length || 0);
             
             // Try to create a test variant directly without form
             console.log('üß™ Creating test variant directly...');
             const testVariant = {
                 id: Date.now(),
                 sku: 'TEST-VARIANT-' + Date.now(),
                 stock: 10,
                 attributes: {
                     'ÿ±ŸÜ⁄Ø': 'ŸÇÿ±ŸÖÿ≤',
                     'ÿ≥ÿß€åÿ≤': 'M'
                 },
                 price_toman: 50000,
                 price_usd: 15
             };
             
             console.log('üîç Test variant created:', testVariant);
             
             // Add to variantState
             if (variantState.variants) {
                 variantState.variants.push(testVariant);
                 console.log('‚úÖ Test variant added to variantState');
                 console.log('‚úÖ New variants count:', variantState.variants.length);
                 
                 // Update the form
                 addVariantDataToForm();
                 
                 alert('‚úÖ ÿ™ÿ≥ÿ™ ŸÖŸàŸÅŸÇ! ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ™ÿ≥ÿ™ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ');
             } else {
                 console.error('‚ùå variantState.variants is not an array');
                 alert('ÿÆÿ∑ÿß: variantState.variants €åÿßŸÅÿ™ ŸÜÿ¥ÿØ');
             }
         };
         
         // Test function to check if variant data is in form
         window.testVariantDataInForm = function() {
             console.log('üß™ TESTING VARIANT DATA IN FORM...');
             
             const form = document.getElementById('product_form');
             if (!form) {
                 console.error('‚ùå Form not found!');
                 return;
             }
             
             // Check for variants_data input
             const variantsDataInput = form.querySelector('input[name="variants_data"]');
             console.log('üîç variants_data input found:', !!variantsDataInput);
             if (variantsDataInput) {
                 console.log('üîç variants_data value:', variantsDataInput.value);
                 try {
                     const variants = JSON.parse(variantsDataInput.value);
                     console.log('üîç Parsed variants:', variants);
                     console.log('üîç Number of variants:', variants.length);
                 } catch (error) {
                     console.error('‚ùå Error parsing variants data:', error);
                 }
             }
             
             // Check for variant_attributes input
             const variantAttributesInput = form.querySelector('input[name="variant_attributes"]');
             console.log('üîç variant_attributes input found:', !!variantAttributesInput);
             if (variantAttributesInput) {
                 console.log('üîç variant_attributes value:', variantAttributesInput.value);
             }
             
             // Check variantState
             console.log('üîç variantState:', variantState);
             console.log('üîç variantState.isEnabled:', variantState?.isEnabled);
             console.log('üîç variantState.variants:', variantState?.variants);
             console.log('üîç variantState.variants.length:', variantState?.variants?.length);
             
             // Force add variant data
             console.log('üîç Forcing addVariantDataToForm...');
             addVariantDataToForm();
             
             // Check again after forcing
             const variantsDataInputAfter = form.querySelector('input[name="variants_data"]');
             console.log('üîç variants_data input found after force:', !!variantsDataInputAfter);
             if (variantsDataInputAfter) {
                 console.log('üîç variants_data value after force:', variantsDataInputAfter.value);
             }
         };
         
         // Alternative simple variant save function
         window.saveVariantSimple = function() {
             console.log('üéØ saveVariantSimple() called');
             
             // Check if variantState exists
             if (typeof variantState === 'undefined') {
                 console.error('‚ùå variantState is not defined!');
                 alert('ÿÆÿ∑ÿß: variantState ÿ™ÿπÿ±€åŸÅ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™');
                 return;
             }
             
             // Get values directly from inputs (if they exist)
             const sku = document.getElementById('variantSku')?.value?.trim() || 'DEFAULT-SKU-' + Date.now();
             const stock = parseInt(document.getElementById('variantStock')?.value) || 0;
             const color = document.getElementById('variantColor')?.value || 'ŸÜÿßŸÖÿ¥ÿÆÿµ';
             const size = document.getElementById('variantSize')?.value || 'ŸÜÿßŸÖÿ¥ÿÆÿµ';
             const material = document.getElementById('variantMaterial')?.value || 'ŸÜÿßŸÖÿ¥ÿÆÿµ';
             
             console.log('üîç SKU:', sku);
             console.log('üîç Stock:', stock);
             console.log('üîç Color:', color);
             console.log('üîç Size:', size);
             console.log('üîç Material:', material);
             
             // Create variant object
             const variant = {
                 id: Date.now(),
                 sku: sku,
                 stock: stock,
                 attributes: {
                     'ÿ±ŸÜ⁄Ø': color,
                     'ÿ≥ÿß€åÿ≤': size,
                     'ÿ¨ŸÜÿ≥': material
                 },
                 price_toman: 0,
                 price_usd: 0
             };
             
             console.log('üîç Created variant:', variant);
             
             // Add to variantState
             if (!variantState.variants) {
                 variantState.variants = [];
             }
             
             variantState.variants.push(variant);
             console.log('‚úÖ Variant added. Total variants:', variantState.variants.length);
             
             // Update the form
             addVariantDataToForm();
             
             // Show success message
             alert('‚úÖ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ!');
             
             // Close modal if it exists
             const variantModal = document.getElementById('variantModal');
             if (modal) {
                 modal.style.display = 'none';
             }
        };

        // Test function to add a test variant
        window.testAddVariantData = function() {
            console.log('üß™ testAddVariantData called');
            
            // Add a test variant
            const testVariant = {
                id: Date.now(),
                sku: 'TEST-VARIANT-' + Date.now(),
                attributes: { color: 'ŸÇÿ±ŸÖÿ≤', size: 'M' },
                priceToman: '150000',
                stock: 10,
                isActive: true,
                images: []
            };
            
            console.log('üß™ Adding test variant:', testVariant);
            
            if (!variantState.variants) {
                variantState.variants = [];
            }
            
            variantState.variants.push(testVariant);
            variantState.isEnabled = true;
            
            console.log('‚úÖ Test variant added. Total variants:', variantState.variants.length);
            console.log('‚úÖ variantState after adding test:', variantState);
            
            // Try to add variant data to form
            if (typeof addVariantDataToForm === 'function') {
                console.log('üîÑ Calling addVariantDataToForm...');
                addVariantDataToForm();
            } else {
                console.log('‚ùå addVariantDataToForm function not found!');
            }
            
            // Check if variants data was added to form
            const form = document.getElementById('product_form');
            if (form) {
                const variantInput = form.querySelector('input[name="variants_data"]');
                if (variantInput) {
                    console.log('‚úÖ variants_data input found with value:', variantInput.value);
                } else {
                    console.log('‚ùå variants_data input NOT found in form!');
                }
            }
        };

        // Test variants toggle function
        window.testVariantsToggle = function() {
            console.log('üß™ testVariantsToggle called');
            const checkbox = document.getElementById('has_variants');
            const content = document.getElementById('variants-content');
            const result = document.getElementById('test-result');
            
            if (checkbox && content) {
                console.log('‚úÖ Checkbox found:', checkbox.checked);
                console.log('‚úÖ Content found, current display:', content.style.display);
                
                // Toggle the checkbox
                checkbox.checked = !checkbox.checked;
                toggleVariantsSection(checkbox);
                
                if (result) {
                    result.textContent = `Checkbox: ${checkbox.checked}, Display: ${content.style.display}`;
                }
            } else {
                console.log('‚ùå Checkbox or content not found!');
                if (result) {
                    result.textContent = 'Error: Elements not found';
                }
            }
        };

        // Test form submission function
        window.testFormSubmission = function() {
            console.log('üß™ testFormSubmission called');
            
            // First add test variant data
            testAddVariantData();
            
            // Wait a bit then submit
            setTimeout(() => {
                console.log('üöÄ Submitting form with test data...');
                const form = document.getElementById('product_form');
                if (form) {
                    form.submit();
                } else {
                    console.log('‚ùå Form not found!');
                }
            }, 500);
        };

         // Immediate form submission function
         window.submitImmediately = function() {
             console.log('‚ö° IMMEDIATE FORM SUBMISSION...');
             
             const form = document.getElementById('product_form');
             if (!form) {
                 console.error('‚ùå Form not found!');
                 return;
             }
             
             // Fill required fields if empty
             const nameField = form.querySelector('input[name="name"]');
             const categoryField = form.querySelector('select[name="category"]');
             const priceField = form.querySelector('input[name="price_toman"]');
             
             if (nameField && !nameField.value) {
                 nameField.value = 'Test Product ' + new Date().toISOString();
             }
             if (categoryField && !categoryField.value) {
                 categoryField.value = '1036';
             }
             if (priceField && !priceField.value) {
                 priceField.value = '100000';
             }
             
             console.log('üìã Form data before immediate submission:');
             const formData = new FormData(form);
             for (let [key, value] of formData.entries()) {
                 console.log(`  ${key}: ${value}`);
             }
             
             // Submit the form immediately
             console.log('‚ö° Submitting form immediately...');
             form.submit();
         };

         // Direct form submission function
         window.submitFormNow = function() {
             console.log('üöÄ DIRECT FORM SUBMISSION...');
             
             const form = document.getElementById('product_form');
             if (!form) {
                 console.error('‚ùå Form not found!');
                 return;
             }
             
             // Fill required fields if empty
             const nameField = form.querySelector('input[name="name"]');
             const categoryField = form.querySelector('select[name="category"]');
             const priceField = form.querySelector('input[name="price_toman"]');
             
             if (nameField && !nameField.value) {
                 nameField.value = 'Test Product ' + new Date().toISOString();
             }
             if (categoryField && !categoryField.value) {
                 categoryField.value = '1036';
             }
             if (priceField && !priceField.value) {
                 priceField.value = '100000';
             }
             
             console.log('üìã Form data before direct submission:');
             const formData = new FormData(form);
             for (let [key, value] of formData.entries()) {
                 console.log(`  ${key}: ${value}`);
             }
             
             // Submit the form directly
             console.log('üöÄ Submitting form directly...');
             form.submit();
         };

         // Direct form submission function
         window.submitFormDirectly = function() {
            console.log('üîÑ Direct form submission...');
            
            // Get the form
            const form = document.getElementById('product_form');
            if (!form) {
                console.error('‚ùå Form not found!');
                return;
            }
            
            // Fill required fields
            const nameField = form.querySelector('input[name="name"]');
            const categoryField = form.querySelector('select[name="category"]');
            const priceField = form.querySelector('input[name="price_toman"]');
            
            if (nameField) nameField.value = 'Test Product ' + new Date().toISOString();
            if (categoryField) categoryField.value = '1036';
            if (priceField) priceField.value = '100000';
            
            // Log form data
            console.log('üìã Form data before submission:');
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            // Submit directly using form.submit()
            try {
                console.log('üöÄ Submitting form directly...');
                form.submit();
            } catch (error) {
                console.error('‚ùå Error submitting form:', error);
                alert('Error submitting form: ' + error.message);
            }
        };
        
        // Test if JavaScript is working - consolidated into main DOMContentLoaded
        
        // Super simple test function - GLOBAL SCOPE
        window.testSimpleVariant = function() {
            console.log('üß™ Super simple test...');
            
            const form = document.getElementById('product_form');
            if (!form) {
                console.log('‚ùå Form not found!');
                return;
            }
            
            // Remove existing variant inputs
            const existingInputs = form.querySelectorAll('input[name="variants_data"]');
            existingInputs.forEach(input => input.remove());
            
            // Add test variant data directly
            const variantDataInput = document.createElement('input');
            variantDataInput.type = 'hidden';
            variantDataInput.name = 'variants_data';
            variantDataInput.value = JSON.stringify([
                {
                    id: 1,
                    sku: 'TEST-001',
                    attributes: { color: 'ŸÇÿ±ŸÖÿ≤', size: 'M' },
                    priceToman: '150000',
                    stock: 10,
                    isActive: true,
                    images: []
                }
            ]);
            form.appendChild(variantDataInput);
            
            console.log('‚úÖ Test variant data added directly to form:', variantDataInput.value);
            
            // Check if it's there
            const checkInput = form.querySelector('input[name="variants_data"]');
            if (checkInput) {
                console.log('‚úÖ Confirmed: variant data in form:', checkInput.value);
            } else {
                console.log('‚ùå Variant data not found in form!');
            }
        };
        
        
        // SIMPLE FUNCTIONS FOR VARIANTS
        function generateSkuNow() {
            const color = document.getElementById('variantColor').value;
            const size = document.getElementById('variantSize').value;
            const material = document.getElementById('variantMaterial').value;
            const productName = document.getElementById('name').value || 'PRODUCT';
            
            let sku = productName.substring(0, 4).toUpperCase();
            if (color) sku += '-' + color;
            if (size) sku += '-' + size;
            if (material) sku += '-' + material.substring(0, 3);
            sku += '-' + Math.floor(Math.random() * 100);
            
            document.getElementById('variantSku').value = sku;
            alert('SKU ÿ™ŸàŸÑ€åÿØ ÿ¥ÿØ: ' + sku);
            return false;
        }

        /* 
        // Duplicate function removed - function saveVariantNow() {
            const sku = document.getElementById('variantSku').value;
            const color = document.getElementById('variantColor').value;
            const size = document.getElementById('variantSize').value;
            const material = document.getElementById('variantMaterial').value;
            const price = document.getElementById('variantPriceToman').value || '150000';
            const stock = document.getElementById('variantStock').value || '0';
            
            if (!sku) {
                alert('ŸÑÿ∑ŸÅÿß ⁄©ÿØ SKU ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                return false;
            }
            
            if (!color && !size && !material) {
                alert('ŸÑÿ∑ŸÅÿß ÿ≠ÿØÿßŸÇŸÑ €å⁄© Ÿà€å⁄ò⁄Ø€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ');
                return false;
            }
            
            const table = document.getElementById('variantsTableBody');
            const row = table.insertRow();
            
            let attributes = '';
            if (color) attributes += '<span class="variant-attribute-badge">ÿ±ŸÜ⁄Ø: ' + color + '</span>';
            if (size) attributes += '<span class="variant-attribute-badge">ÿ≥ÿß€åÿ≤: ' + size + '</span>';
            if (material) attributes += '<span class="variant-attribute-badge">ÿ¨ŸÜÿ≥: ' + material + '</span>';
            
            row.innerHTML = 
                '<td>' + sku + '</td>' +
                '<td>' + attributes + '</td>' +
                '<td>' + parseInt(price).toLocaleString() + ' ÿ™ŸàŸÖÿßŸÜ</td>' +
                '<td>' + stock + '</td>' +
                '<td><span class="variant-status status-active"><span class="status-indicator"></span>ŸÅÿπÿßŸÑ</span></td>' +
                '<td><button onclick="this.closest(\'tr\').remove()">ÿ≠ÿ∞ŸÅ</button></td>';
            
            // Clear form
            document.getElementById('variantSku').value = '';
            document.getElementById('variantColor').value = '';
            document.getElementById('variantSize').value = '';
            document.getElementById('variantMaterial').value = '';
            document.getElementById('variantPriceToman').value = '';
            document.getElementById('variantStock').value = '';
            
            alert('‚úÖ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ!');
            return false;
        }
        */
        function generateSKUSimple() {
            const productName = document.getElementById('name').value || 'PRODUCT';
            const color = document.getElementById('variantColor').value;
            const size = document.getElementById('variantSize').value;
            const material = document.getElementById('variantMaterial').value;
            
            let sku = productName.substring(0, 4).toUpperCase();
            if (color) sku += '-' + color.substring(0, 3);
            if (size) sku += '-' + size;
            if (material) sku += '-' + material.substring(0, 3);
            sku += '-' + Math.floor(Math.random() * 100).toString().padStart(2, '0');
            
            document.getElementById('variantSku').value = sku;
            alert('SKU ÿ™ŸàŸÑ€åÿØ ÿ¥ÿØ: ' + sku);
        }
        
        function saveVariantSimple() {
            const sku = document.getElementById('variantSku').value.trim();
            const price = document.getElementById('variantPriceToman').value || '150000';
            const stock = document.getElementById('variantStock').value || '0';
            const color = document.getElementById('variantColor').value;
            const size = document.getElementById('variantSize').value;
            const material = document.getElementById('variantMaterial').value;
            
            if (!sku) {
                alert('ŸÑÿ∑ŸÅÿß ⁄©ÿØ SKU ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                return;
            }
            
            if (!color && !size && !material) {
                alert('ŸÑÿ∑ŸÅÿß ÿ≠ÿØÿßŸÇŸÑ €å⁄© Ÿà€å⁄ò⁄Ø€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ');
                return;
            }
            
            const tbody = document.getElementById('variantsTableBody');
            const row = document.createElement('tr');
            
            let attributes = '';
            if (color) attributes += '<span class="variant-attribute-badge">ÿ±ŸÜ⁄Ø: ' + color + '</span>';
            if (size) attributes += '<span class="variant-attribute-badge">ÿ≥ÿß€åÿ≤: ' + size + '</span>';
            if (material) attributes += '<span class="variant-attribute-badge">ÿ¨ŸÜÿ≥: ' + material + '</span>';
            
            row.innerHTML = '<td>' + sku + '</td>' +
                           '<td><div class="variant-attributes-display">' + attributes + '</div></td>' +
                           '<td>' + parseInt(price).toLocaleString() + ' ÿ™ŸàŸÖÿßŸÜ</td>' +
                           '<td>' + stock + '</td>' +
                           '<td><span class="variant-status status-active"><span class="status-indicator"></span>ŸÅÿπÿßŸÑ</span></td>' +
                           '<td><button class="variant-action-btn delete-variant-btn" onclick="this.closest(\'tr\').remove()">ÿ≠ÿ∞ŸÅ</button></td>';
            
            tbody.appendChild(row);
            document.getElementById('variantForm').reset();
            alert('‚úÖ ŸÖÿ≠ÿµŸàŸÑ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ!');
        }

        // SIMPLE DIRECT FUNCTION - GUARANTEED TO WORK
        function toggleVariants(checkbox) {
            const content = document.getElementById('variants-content');
            const grid = document.getElementById('variantAttributesGrid');
            
            if (checkbox.checked) {
                content.style.display = 'block';
                
                // Add test attributes immediately
                grid.innerHTML = `
                    <div class="variant-attribute-item selected" onclick="toggleAttributeSelection(this, 'ÿ±ŸÜ⁄Ø')">
                        <input type="checkbox" checked>
                        <div class="variant-attribute-info">
                            <div class="variant-attribute-name">ÿ±ŸÜ⁄Ø</div>
                            <div class="variant-attribute-values">ŸÇÿ±ŸÖÿ≤ÿå ÿ¢ÿ®€åÿå ÿ≥ŸÅ€åÿØÿå ÿ≥€åÿßŸá</div>
                        </div>
                    </div>
                    <div class="variant-attribute-item" onclick="toggleAttributeSelection(this, 'ÿ≥ÿß€åÿ≤')">
                        <input type="checkbox">
                        <div class="variant-attribute-info">
                            <div class="variant-attribute-name">ÿ≥ÿß€åÿ≤</div>
                            <div class="variant-attribute-values">Sÿå Mÿå Lÿå XLÿå 2XL</div>
                        </div>
                    </div>
                    <div class="variant-attribute-item" onclick="toggleAttributeSelection(this, 'ÿ¨ŸÜÿ≥')">
                        <input type="checkbox">
                        <div class="variant-attribute-info">
                            <div class="variant-attribute-name">ÿ¨ŸÜÿ≥</div>
                            <div class="variant-attribute-values">ŸæŸÜÿ®Ÿáÿå ŸæŸÑ€å‚Äåÿßÿ≥ÿ™ÿ±ÿå Ÿæÿ¥ŸÖ</div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="generateTestVariants()" style="margin-top: 1rem;">ÿ™ŸàŸÑ€åÿØ ÿßŸÜŸàÿßÿπ ŸÖÿ≠ÿµŸàŸÑ</button>
                `;
                
                // Show generator section
                document.getElementById('variantGenerator').style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        }

        // toggleAttributeSelection moved to global scope above

        // generateTestVariants moved to global scope above

        // Simple modal functions
        function openVariantModal() {
            const variantModal = document.getElementById('variantModal');
            const form = document.getElementById('variantForm');
            
            // Clear the form
            form.reset();
            document.getElementById('variantIndex').value = '';
            document.getElementById('variantModalTitle').textContent = 'ÿßŸÅÿ≤ŸàÿØŸÜ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ¨ÿØ€åÿØ';
            
            // Show basic attribute inputs
            const attributesForm = document.getElementById('variantAttributesForm');
            attributesForm.innerHTML = `
                <div class="variant-attribute-input">
                    <label>ÿ±ŸÜ⁄Ø</label>
                    <select name="variant_attr_color" class="form-control">
                        <option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>
                        <option value="ŸÇÿ±ŸÖÿ≤">ŸÇÿ±ŸÖÿ≤</option>
                        <option value="ÿ¢ÿ®€å">ÿ¢ÿ®€å</option>
                        <option value="ÿ≥ŸÅ€åÿØ">ÿ≥ŸÅ€åÿØ</option>
                        <option value="ÿ≥€åÿßŸá">ÿ≥€åÿßŸá</option>
                        <option value="ÿ≥ÿ®ÿ≤">ÿ≥ÿ®ÿ≤</option>
                    </select>
                </div>
                <div class="variant-attribute-input">
                    <label>ÿ≥ÿß€åÿ≤</label>
                    <select name="variant_attr_size" class="form-control">
                        <option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="2XL">2XL</option>
                    </select>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function closeVariantModal() {
            document.getElementById('variantModal').style.display = 'none';
        }
        
        function generateAutoSKU() {
            const productName = document.getElementById('name').value || 'PRODUCT';
            const color = document.getElementById('variantColor').value;
            const size = document.getElementById('variantSize').value;
            const material = document.getElementById('variantMaterial').value;
            
            let skuParts = [productName.substring(0, 4).toUpperCase()];
            
            if (color) skuParts.push(color.substring(0, 3));
            if (size) skuParts.push(size);
            if (material) skuParts.push(material.substring(0, 3));
            
            // Add random number to ensure uniqueness
            const randomNum = Math.floor(Math.random() * 100).toString().padStart(2, '0');
            skuParts.push(randomNum);
            
            const generatedSKU = skuParts.join('-');
            document.getElementById('variantSku').value = generatedSKU;
            
            alert('‚úÖ ⁄©ÿØ SKU ÿ™ŸàŸÑ€åÿØ ÿ¥ÿØ: ' + generatedSKU);
        }

        function saveVariant() {
            const sku = document.getElementById('variantSku').value.trim();
            const price = document.getElementById('variantPriceToman').value.replace(/,/g, '') || document.getElementById('price_toman').value || '150000';
            const stock = document.getElementById('variantStock').value || '0';
            const isActive = document.getElementById('variantIsActive').checked;
            
            const color = document.getElementById('variantColor').value;
            const size = document.getElementById('variantSize').value;
            const material = document.getElementById('variantMaterial').value;
            
            if (!sku) {
                alert('ŸÑÿ∑ŸÅÿß ⁄©ÿØ ŸÖÿ≠ÿµŸàŸÑ (SKU) ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ €åÿß ÿßÿ≤ ÿØ⁄©ŸÖŸá "ÿ™ŸàŸÑ€åÿØ ÿÆŸàÿØ⁄©ÿßÿ±" ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åÿØ');
                return;
            }
            
            if (!color && !size && !material) {
                alert('ŸÑÿ∑ŸÅÿß ÿ≠ÿØÿßŸÇŸÑ €å⁄© Ÿà€å⁄ò⁄Ø€å (ÿ±ŸÜ⁄Øÿå ÿ≥ÿß€åÿ≤ €åÿß ÿ¨ŸÜÿ≥) ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ');
                return;
            }
            
            // Check for duplicate SKU
            const existingRows = document.querySelectorAll('#variantsTableBody tr');
            for (let row of existingRows) {
                if (row.cells[0].textContent === sku) {
                    alert('‚ùå ÿß€åŸÜ ⁄©ÿØ SKU ŸÇÿ®ŸÑÿßŸã ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿ¥ÿØŸá ÿßÿ≥ÿ™');
                    return;
                }
            }
            
            // Add to table
            const tbody = document.getElementById('variantsTableBody');
            const row = document.createElement('tr');
            
            const attributes = [];
            if (color) attributes.push(`ÿ±ŸÜ⁄Ø: ${color}`);
            if (size) attributes.push(`ÿ≥ÿß€åÿ≤: ${size}`);
            if (material) attributes.push(`ÿ¨ŸÜÿ≥: ${material}`);
            
            row.innerHTML = `
                <td>${sku}</td>
                <td>
                    <div class="variant-attributes-display">
                        ${attributes.map(attr => `<span class="variant-attribute-badge">${attr}</span>`).join('')}
                    </div>
                </td>
                <td>${parseInt(price).toLocaleString()} ÿ™ŸàŸÖÿßŸÜ</td>
                <td>${stock}</td>
                <td>
                    <span class="variant-status ${isActive ? 'status-active' : 'status-inactive'}">
                        <span class="status-indicator"></span>
                        ${isActive ? 'ŸÅÿπÿßŸÑ' : 'ÿ∫€åÿ±ŸÅÿπÿßŸÑ'}
                    </span>
                </td>
                <td>
                    <div class="variant-actions">
                        <button class="variant-action-btn edit-variant-btn" onclick="editVariantRow(this)">Ÿà€åÿ±ÿß€åÿ¥</button>
                        <button class="variant-action-btn delete-variant-btn" onclick="deleteVariantRow(this)">ÿ≠ÿ∞ŸÅ</button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // Clear form for next entry
            document.getElementById('variantForm').reset();
            document.getElementById('variantSku').value = '';
            
            alert('‚úÖ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ¨ÿØ€åÿØ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ!');
            
            // Don't close modal automatically, let user add more variants
            // document.getElementById('variantModal').style.display = 'none';
        }
        
        function editVariantRow(btn) {
            alert('Ÿà€åÿ±ÿß€åÿ¥ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ - ÿØÿ± ÿ≠ÿßŸÑ ÿ™Ÿàÿ≥ÿπŸá');
        }
        
        function deleteVariantRow(btn) {
            if (confirm('ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿß€åŸÜ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØÿü')) {
                btn.closest('tr').remove();
                alert('‚úÖ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ');
            }
        }

        // saveVariant function moved to global scope above
        
        function loadExistingVariants() {
            console.log('üöÄ loadExistingVariants function called');
            try {
                const existingVariantsElement = document.getElementById('existing-variants-data');
                console.log('üîç existingVariantsElement:', existingVariantsElement);
                
                if (!existingVariantsElement) {
                    console.log('‚ùå No existing-variants-data element found');
                    return;
                }
                
                const existingVariants = JSON.parse(existingVariantsElement.textContent);
                console.log('üîç Loading existing variants:', existingVariants);
                console.log('üîç Variants count:', existingVariants.length);
                
                if (existingVariants && existingVariants.length > 0) {
                    console.log('‚úÖ Found existing variants, showing section');
                    
                    // Show the variants section
                    const variantsContent = document.getElementById('variants-content');
                    const hasVariantsCheckbox = document.getElementById('has_variants');
                    
                    console.log('üîç variantsContent:', variantsContent);
                    console.log('üîç hasVariantsCheckbox:', hasVariantsCheckbox);
                    
                    if (variantsContent && hasVariantsCheckbox) {
                        hasVariantsCheckbox.checked = true;
                        variantsContent.style.display = 'block';
                        console.log('‚úÖ Variants section made visible');
                    }
                    
                    // Show the variants management table
                    const variantsManagement = document.getElementById('variantsManagement');
                    if (variantsManagement) {
                        variantsManagement.style.display = 'block';
                        console.log('‚úÖ Variants management table made visible');
                    }
                    
                    // Load variants into the table
                    const tableBody = document.getElementById('variantsTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = ''; // Clear existing rows
                        
                        existingVariants.forEach((variant, index) => {
                            console.log(`üîç Processing variant ${index + 1}:`, variant);
                            const row = document.createElement('tr');
                            const color = variant.color || 'ŸÜÿßŸÖÿ¥ÿÆÿµ';
                            const size = variant.size || 'ŸÜÿßŸÖÿ¥ÿÆÿµ';
                            const material = variant.material || 'ŸÜÿßŸÖÿ¥ÿÆÿµ';
                            const status = variant.is_active ? 'ŸÅÿπÿßŸÑ' : 'ÿ∫€åÿ±ŸÅÿπÿßŸÑ';
                            
                            row.innerHTML = `
                                <td><strong>${variant.sku}</strong></td>
                                <td>
                                    <span class="variant-attribute-badge" style="background: ${getColorCode(color)}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">
                                        ${color}
                                    </span>
                                </td>
                                <td>${size}</td>
                                <td>${material}</td>
                                <td>${parseInt(variant.price_toman).toLocaleString()} ÿ™ŸàŸÖÿßŸÜ</td>
                                <td>${variant.stock_quantity}</td>
                                <td class="variant-status ${variant.is_active ? 'active' : 'inactive'}">${status}</td>
                                <td class="variant-actions">
                                    <button type="button" class="variant-action-btn edit-variant-btn" onclick="editVariant(${variant.id})">Ÿà€åÿ±ÿß€åÿ¥</button>
                                    <button type="button" class="variant-action-btn delete-variant-btn" onclick="deleteVariant(${variant.id})">ÿ≠ÿ∞ŸÅ</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        console.log('‚úÖ Loaded', existingVariants.length, 'existing variants into table');
                    } else {
                        console.log('‚ùå variantsTableBody not found');
                    }
                } else {
                    console.log('‚ùå No existing variants found');
                }
            } catch (error) {
                console.error('‚ùå Error loading existing variants:', error);
                console.error('Error details:', error.message);
                console.error('Stack trace:', error.stack);
            }
        }
        
        function getColorCode(color) {
            const colorMap = {
                'ŸÇÿ±ŸÖÿ≤': '#dc3545',
                'ÿ¢ÿ®€å': '#007bff', 
                'ÿ≥ÿ®ÿ≤': '#28a745',
                'ÿ≤ÿ±ÿØ': '#ffc107',
                'ÿ≥€åÿßŸá': '#343a40',
                'ÿ≥ŸÅ€åÿØ': '#6c757d',
                'ÿµŸàÿ±ÿ™€å': '#e83e8c',
                'ŸÜÿßÿ±ŸÜÿ¨€å': '#fd7e14',
                'ÿ®ŸÜŸÅÿ¥': '#6f42c1',
                'ŸÇŸáŸàŸá‚Äåÿß€å': '#795548'
            };
            return colorMap[color] || '#6c757d';
        }
        
        function editVariant(variantId) {
            alert('Ÿà€åÿ±ÿß€åÿ¥ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ®ÿß ID: ' + variantId);
            // TODO: Implement variant editing
        }
        
        function deleteVariant(variantId) {
            if (confirm('ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿß€åŸÜ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØÿü')) {
                alert('ÿ≠ÿ∞ŸÅ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ®ÿß ID: ' + variantId);
                // TODO: Implement variant deletion
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOMContentLoaded event fired');
            console.log('‚úÖ DOM loaded, JavaScript is working!');
            
            // Load existing variants if editing a product
            loadExistingVariants();
            
            // Also try loading variants after a short delay as a fallback
            setTimeout(function() {
                console.log('üîÑ Fallback: Trying to load variants again after delay');
                loadExistingVariants();
            }, 1000);
            
            // Keep cropped File objects reliably, instead of re-fetching blob URLs later
            const croppedFileMap = new WeakMap();
            // Parse category attributes JSON
            let categoryAttributes = {};
            let existingAttrs = {};
            try {
                categoryAttributes = JSON.parse('{{ category_attributes|escapejs }}');
            } catch (e) {
                categoryAttributes = {};
            }
            
            // Make categoryAttributes globally accessible
            window.categoryAttributes = categoryAttributes;
            try {
                existingAttrs = JSON.parse('{{ existing_attrs|escapejs }}');
            } catch (e) {
                existingAttrs = {};
            }

            const categorySelect = document.getElementById('id_category');
            const attributesContainer = document.getElementById('attributes-container');

            function renderAttributes(categoryId) {
                attributesContainer.innerHTML = '';
                if (!categoryId || !categoryAttributes[categoryId] || categoryAttributes[categoryId].length === 0) {
                    attributesContainer.innerHTML = '<div style="color: #888;">Ÿà€å⁄ò⁄Ø€å‚Äåÿß€å ÿ®ÿ±ÿß€å ÿß€åŸÜ ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å ÿ™ÿπÿ±€åŸÅ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™.</div>';
                    return;
                }
                categoryAttributes[categoryId].forEach(attr => {
                    let fieldHtml = '';
                    const required = attr.required ? 'required' : '';
                    const label = `<label>${attr.key}${attr.required ? ' <span style=\'color:red\'>*</span>' : ''}</label>`;
                    const existingValue = existingAttrs[attr.key] || '';
                    if (attr.type === 'select') {
                        fieldHtml = `<select name="attr_${attr.key}" class="form-control" ${required}>
                            <option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>
                            ${attr.values.map(v => `<option value="${v}"${existingValue === v ? ' selected' : ''}>${v}</option>`).join('')}
                        </select>`;
                    } else if (attr.type === 'multiselect') {
                        fieldHtml = `<select name="attr_${attr.key}" class="form-control" multiple ${required}>
                            ${attr.values.map(v => `<option value="${v}"${Array.isArray(existingValue) ? existingValue.includes(v) : (existingValue === v) ? ' selected' : ''}>${v}</option>`).join('')}
                        </select>`;
                    } else if (attr.type === 'number') {
                        fieldHtml = `<input type="number" name="attr_${attr.key}" class="form-control" value="${existingValue}" ${required} />`;
                    } else if (attr.type === 'boolean') {
                        fieldHtml = `<input type="checkbox" name="attr_${attr.key}" class="form-check-input" ${existingValue ? 'checked' : ''} ${required} />`;
                    } else {
                        fieldHtml = `<input type="text" name="attr_${attr.key}" class="form-control" value="${existingValue}" ${required} />`;
                    }
                    attributesContainer.innerHTML += `<div class="attribute-group">${label}${fieldHtml}</div>`;
                });
            }

            // Initial render (if editing)
            if (categorySelect.value) {
                renderAttributes(categorySelect.value);
            }

            // Update on category change
            categorySelect.addEventListener('change', function() {
                renderAttributes(this.value);
            });

            const imageInput = document.getElementById('imageInput');
            const imagePreviews = document.getElementById('imagePreviews');
            const imageUpload = document.querySelector('.image-upload');
            let processedFiles = new Set();
            let cropper = null;
            let imagesToDelete = new Set();

            // Initialize Sortable for image previews
            new Sortable(imagePreviews, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.preview-item img',
                onEnd: function() {
                    updatePositions();
                }
            });

            // Initialize existing images if editing a product
            const productImages = JSON.parse('{{ product_images|safe }}');
            if (productImages && productImages.length > 0) {
                productImages.forEach((img, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.dataset.imageId = img.id;
                    
                    const imgElem = document.createElement('img');
                    imgElem.src = img.url;
                    imgElem.alt = 'Preview';

                    const positionLabel = document.createElement('div');
                    positionLabel.className = 'position-label';
                    positionLabel.textContent = `${index + 1}/${productImages.length}`;

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-btn';
                    removeBtn.title = 'Remove Image';
                                            removeBtn.textContent = '‚úï';

                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'edit-btn';
                    editBtn.title = 'Edit Image';
                    editBtn.textContent = '‚úèÔ∏è';

                    previewItem.appendChild(imgElem);
                    previewItem.appendChild(positionLabel);
                    previewItem.appendChild(removeBtn);
                    previewItem.appendChild(editBtn);

                    // Handle edit button
                    const editBtnElement = previewItem.querySelector('.edit-btn');
                    editBtnElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const img = previewItem.querySelector('img');
                        openCropModal(img.src, previewItem);
                    });

                    // Handle remove button for existing images
                    const removeBtnElement = previewItem.querySelector('.remove-btn');
                    removeBtnElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (confirm('ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿß€åŸÜ ÿ™ÿµŸà€åÿ± ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØÿü')) {
                            // If this is an existing image (has imageId), track it for deletion
                            if (previewItem.dataset.imageId) {
                                imagesToDelete.add(previewItem.dataset.imageId);
                            }
                            
                            previewItem.remove();
                            processedFiles.delete(img.src);
                            updatePositions();
                        }
                    });

                    // Add this to prevent drag from starting on buttons
                    const buttons = previewItem.querySelectorAll('.remove-btn, .edit-btn');
                    buttons.forEach(btn => {
                        btn.addEventListener('mousedown', e => e.stopPropagation());
                        btn.addEventListener('pointerdown', e => e.stopPropagation());
                    });

                    imagePreviews.appendChild(previewItem);
                });
            }

            // Handle file selection
            imageInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    handleFiles(e.target.files);
                }
            });

            // Handle drag and drop
            imageUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                imageUpload.classList.add('highlight');
            });

            imageUpload.addEventListener('dragleave', function() {
                imageUpload.classList.remove('highlight');
            });

            imageUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                imageUpload.classList.remove('highlight');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });

            function handleFiles(files) {
                const maxFiles = 10;
                const currentFiles = imagePreviews.children.length;
                const remainingSlots = maxFiles - currentFiles;

                if (files.length > remainingSlots) {
                    alert(`ÿ¥ŸÖÿß ŸÅŸÇÿ∑ ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ${remainingSlots} ÿ™ÿµŸà€åÿ± ÿØ€å⁄Øÿ± ÿ¢ŸæŸÑŸàÿØ ⁄©ŸÜ€åÿØ (ÿ≠ÿØÿß⁄©ÿ´ÿ± 10 ÿ™ÿµŸà€åÿ±)`);
                    return;
                }

                Array.from(files).forEach(file => {
                    if (!file.type.startsWith('image/')) {
                        alert('ŸÑÿ∑ŸÅÿß ŸÅŸÇÿ∑ ŸÅÿß€åŸÑ‚ÄåŸáÿß€å ÿ™ÿµŸà€åÿ±€å ÿ¢ŸæŸÑŸàÿØ ⁄©ŸÜ€åÿØ (JPEG, PNG, GIF)');
                        return;
                    }

                    const maxSize = 10 * 1024 * 1024; // 10MB
                    if (file.size > maxSize) {
                        alert('ÿ≠ÿ¨ŸÖ ŸÅÿß€åŸÑ ŸÜÿ®ÿß€åÿØ ÿ®€åÿ¥ÿ™ÿ± ÿßÿ≤ 10 ŸÖ⁄Øÿßÿ®ÿß€åÿ™ ÿ®ÿßÿ¥ÿØ');
                        return;
                    }

                    if (processedFiles.has(file.name)) {
                        return;
                    }
                    processedFiles.add(file.name);

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item';
                        previewItem.dataset.originalFileName = file.name;
                        
                        const imgElem = document.createElement('img');
                        imgElem.src = e.target.result;
                        imgElem.alt = 'Preview';

                        const positionLabel = document.createElement('div');
                        positionLabel.className = 'position-label';
                        positionLabel.textContent = `${imagePreviews.children.length + 1}/${imagePreviews.children.length + 1}`;

                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-btn';
                        removeBtn.title = 'Remove Image';
                        removeBtn.textContent = '‚úï';

                        const editBtn = document.createElement('button');
                        editBtn.type = 'button';
                        editBtn.className = 'edit-btn';
                        editBtn.title = 'Edit Image';
                        editBtn.textContent = '‚úèÔ∏è';

                        previewItem.appendChild(imgElem);
                        previewItem.appendChild(positionLabel);
                        previewItem.appendChild(removeBtn);
                        previewItem.appendChild(editBtn);

                        // Handle edit button
                        const editBtnElement = previewItem.querySelector('.edit-btn');
                        editBtnElement.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const img = previewItem.querySelector('img');
                            openCropModal(img.src, previewItem);
                        });

                        // Handle remove button
                        const removeBtnElement = previewItem.querySelector('.remove-btn');
                        removeBtnElement.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            if (confirm('ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿß€åŸÜ ÿ™ÿµŸà€åÿ± ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØÿü')) {
                                // If this is an existing image (has imageId), track it for deletion
                                if (previewItem.dataset.imageId) {
                                    imagesToDelete.add(previewItem.dataset.imageId);
                                }
                                previewItem.remove();
                                processedFiles.delete(file.name);
                                updatePositions();
                            }
                        });

                        // Add this to prevent drag from starting on buttons
                        const buttons = previewItem.querySelectorAll('.remove-btn, .edit-btn');
                        buttons.forEach(btn => {
                            btn.addEventListener('mousedown', e => e.stopPropagation());
                            btn.addEventListener('pointerdown', e => e.stopPropagation());
                        });

                        imagePreviews.appendChild(previewItem);
                        updatePositions();
                    };
                    reader.readAsDataURL(file);
                });
            }

            function updatePositions() {
                const items = imagePreviews.children;
                Array.from(items).forEach((item, index) => {
                    const label = item.querySelector('.position-label');
                    if (label) {
                        label.textContent = `${index + 1}/${items.length}`;
                    }
                });
            }

            // Update the crop modal save button functionality
            function openCropModal(imageUrl, previewItem) {
                const cropModal = document.querySelector('.crop-modal');
                const cropImage = document.getElementById('cropImage');
                
                cropImage.src = imageUrl;
                cropModal.classList.add('active');
                
                // Initialize cropper after image is loaded
                cropImage.onload = function() {
                    if (cropper) {
                        cropper.destroy();
                    }
                    
                    cropper = new Cropper(cropImage, {
                        aspectRatio: 4/5,
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        minContainerWidth: 195,
                        minContainerHeight: 244,
                        maxContainerWidth: 195,
                        maxContainerHeight: 244
                    });
                };

                // Handle save button
                const saveBtn = cropModal.querySelector('.crop-save-btn');
                saveBtn.onclick = function() {
                    if (cropper) {
                        const canvas = cropper.getCroppedCanvas({
                            width: 800, // Fixed width for 4:5 aspect ratio
                            height: 1000, // Fixed height for 4:5 aspect ratio (800 * 5/4)
                            fillColor: '#fff',
                            imageSmoothingEnabled: true,
                            imageSmoothingQuality: 'high',
                        });

                        if (canvas) {
                            // Convert canvas to blob
                            canvas.toBlob(function(blob) {
                                // Create a new File object from the blob
                                const fileName = previewItem.dataset.originalFileName || 'cropped-image.jpg';
                                const file = new File([blob], fileName, { type: 'image/jpeg' });
                                
                                // Create a new FileList-like object
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                
                                // Update the file input
                                const imageInput = document.getElementById('imageInput');
                                const newFileList = dataTransfer.files;
                                
                                // If this is a new image (not editing existing)
                                if (!previewItem.dataset.imageId) {
                                    // Add the new file to the input
                                    imageInput.files = newFileList;
                                    
                                    // Update the preview image
                                    const img = previewItem.querySelector('img');
                                    const objectUrl = URL.createObjectURL(blob);
                                    img.src = objectUrl;
                                    // Store file directly for submission
                                    croppedFileMap.set(previewItem, file);
                                    // Also keep a marker for edited state
                                    previewItem.dataset.croppedImage = '1';
                                } else {
                                    // For existing images, keep the imageId and update in place
                                    const originalImageId = previewItem.dataset.imageId;
                                    console.log('Cropping existing image with ID:', originalImageId);
                                    
                                    // DON'T delete imageId - keep it to maintain position
                                    // DON'T add to imagesToDelete - we're updating, not deleting
                                    
                                    const img = previewItem.querySelector('img');
                                    const objectUrl = URL.createObjectURL(blob);
                                    img.src = objectUrl;
                                    // Store the file for submission to replace existing image
                                    croppedFileMap.set(previewItem, file);
                                    // Also mark as edited
                                    previewItem.dataset.croppedImage = '1';
                                    console.log('Stored cropped file in map, keeping imageId:', originalImageId);
                                }
                            }, 'image/jpeg', 0.95);
                        }

                        cropper.destroy();
                        cropper = null;
                    }
                    cropModal.classList.remove('active');
                };

                // Handle cancel button
                const cancelBtn = cropModal.querySelector('.crop-cancel-btn');
                cancelBtn.onclick = function() {
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    cropModal.classList.remove('active');
                };
            }

            // Handle status toggle
            const toggleSwitch = document.getElementById('is_active');
            const statusText = document.getElementById('statusText');
            
            function updateToggleState() {
                if (toggleSwitch.checked) {
                    statusText.textContent = 'ŸÅÿπÿßŸÑ';
                    statusText.classList.remove('inactive');
                    statusText.classList.add('active');
                } else {
                    statusText.textContent = 'ÿ∫€åÿ±ŸÅÿπÿßŸÑ';
                    statusText.classList.remove('active');
                    statusText.classList.add('inactive');
                }
            }
            
            // Set initial state
            updateToggleState();
            
            // Add click event listener to the switch container
            const switchContainer = document.querySelector('.switch');
            switchContainer.addEventListener('click', function(e) {
                // Prevent the click from being handled twice
                if (e.target === toggleSwitch) return;
                
                // Toggle the checkbox
                toggleSwitch.checked = !toggleSwitch.checked;
                updateToggleState();
            });
            
            // Also listen for direct changes to the checkbox
            toggleSwitch.addEventListener('change', updateToggleState);

            // SIMPLIFIED form submission handler
            async function handleFormSubmit(event) {
                console.log('üöÄ Form submission started');
                
                // Check if this is a regular save button (not AJAX)
                const submitBtn = event.submitter;
                console.log('üîò Submit button:', submitBtn);
                console.log('üîò Submit button name:', submitBtn?.name);
                console.log('üîò Submit button type:', submitBtn?.type);
                console.log('üîò Submit button value:', submitBtn?.value);
                console.log('üîò Submit button data-regular-save:', submitBtn?.getAttribute('data-regular-save'));
                
                // Allow normal submission for regular save buttons
                if (submitBtn && submitBtn.type === 'submit' && 
                    (submitBtn.name === '_save' || submitBtn.name === '_addanother' || submitBtn.name === '_continue' ||
                     submitBtn.value === 'ÿ∞ÿÆ€åÿ±Ÿá' || submitBtn.value === 'ÿ∞ÿÆ€åÿ±Ÿá ŸÖÿ≠ÿµŸàŸÑ' || submitBtn.value === 'ÿ∞ÿÆ€åÿ±Ÿá Ÿà ÿßŸÅÿ≤ŸàÿØŸÜ ŸÖÿ≠ÿµŸàŸÑ ÿ¨ÿØ€åÿØ' || submitBtn.value === 'ÿ∞ÿÆ€åÿ±Ÿá Ÿà ÿßÿØÿßŸÖŸá Ÿà€åÿ±ÿß€åÿ¥' ||
                     submitBtn.getAttribute('data-regular-save') === 'true')) {
                    console.log('üìù Regular save button clicked, allowing normal submission');
                    // Don't prevent default for regular save buttons
                    return;
                }
                
                console.log('üîÑ Using AJAX submission');
                event.preventDefault();
                
                const form = event.target;
                const ajaxSubmitBtn = form.querySelector('.submit-btn');
                
                // Disable submit button to prevent double submission
                if (ajaxSubmitBtn) {
                    ajaxSubmitBtn.disabled = true;
                    ajaxSubmitBtn.textContent = 'ÿØÿ± ÿ≠ÿßŸÑ ÿ∞ÿÆ€åÿ±Ÿá...';
                    console.log('‚úÖ Submit button disabled');
                }
                
                try {
                    // Create FormData from the form
                    const formData = new FormData(form);
                    
                    // Debug: Log form data
                    console.log('üìã Form data being submitted:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`  ${key}:`, value);
                    }
                    
                    // Submit via fetch
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    console.log('üì• Response received:', response.status, response.statusText);
                    
                    if (response.ok) {
                    const data = await response.json();
                    console.log('üìÑ Response data:', data);
                    
                    if (data.success) {
                        console.log('‚úÖ Form submitted successfully, redirecting to:', data.redirect_url);
                        window.location.href = data.redirect_url;
                    } else {
                        console.error('‚ùå Form submission failed:', data.error);
                            alert('ÿÆÿ∑ÿß ÿØÿ± ÿ∞ÿÆ€åÿ±Ÿá ŸÖÿ≠ÿµŸàŸÑ: ' + (data.error || 'ÿÆÿ∑ÿß€å ŸÜÿßŸÖÿ¥ÿÆÿµ'));
                            if (ajaxSubmitBtn) {
                                ajaxSubmitBtn.disabled = false;
                                ajaxSubmitBtn.textContent = 'ÿ∞ÿÆ€åÿ±Ÿá';
                            }
                        }
                    } else {
                        console.error('‚ùå HTTP error:', response.status);
                        alert('ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ±: ' + response.status);
                        if (ajaxSubmitBtn) {
                            ajaxSubmitBtn.disabled = false;
                            ajaxSubmitBtn.textContent = 'ÿ∞ÿÆ€åÿ±Ÿá';
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Form submission error:', error);
                    alert('ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ≥ÿßŸÑ ŸÅÿ±ŸÖ: ' + error.message);
                    
                    // Re-enable submit button
                    if (ajaxSubmitBtn) {
                        ajaxSubmitBtn.disabled = false;
                        ajaxSubmitBtn.textContent = 'ÿ∞ÿÆ€åÿ±Ÿá';
                    }
                }
            }

            // Simplified form handling
            const form = document.getElementById('product_form');
            if (form) {
                console.log('üîç Form found, setting up simple handlers...');
                
                // Add click listeners to test buttons
                const testButtons = form.querySelectorAll('button[type="button"]');
                console.log(`üîç Found ${testButtons.length} test buttons`);
                testButtons.forEach((btn, index) => {
                    btn.addEventListener('click', function(e) {
                        console.log(`üîò Test button ${index + 1} clicked:`, btn.textContent);
                    });
                });
                console.log('‚úÖ Simple handlers set up');
            } else {
                console.error('‚ùå Could not find form with ID: product_form');
            }

            // Add brand image preview functionality
            const brandImageInput = document.getElementById('brand_image');
            const brandImagePreview = document.getElementById('brandImagePreview');

            brandImageInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // Check file type
                    if (!file.type.startsWith('image/')) {
                        alert('ŸÑÿ∑ŸÅÿß ŸÅŸÇÿ∑ ŸÅÿß€åŸÑ‚ÄåŸáÿß€å ÿ™ÿµŸà€åÿ±€å ÿ¢ŸæŸÑŸàÿØ ⁄©ŸÜ€åÿØ (JPEG, PNG, GIF)');
                        return;
                    }

                    // Check file size (10MB limit)
                    const maxSize = 10 * 1024 * 1024;
                    if (file.size > maxSize) {
                        alert('ÿ≠ÿ¨ŸÖ ŸÅÿß€åŸÑ ŸÜÿ®ÿß€åÿØ ÿ®€åÿ¥ÿ™ÿ± ÿßÿ≤ 10 ŸÖ⁄Øÿßÿ®ÿß€åÿ™ ÿ®ÿßÿ¥ÿØ');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        brandImagePreview.innerHTML = `<img src="${e.target.result}" alt="Brand Image" style="max-width: 200px;">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // ==================== PRODUCT VARIANTS MANAGEMENT ====================
        
        // State management for variants
        const variantState = {
            isEnabled: false,
            selectedAttributes: new Set(),
            variants: [],
            availableAttributes: []
        };

        // Load available attributes for the selected category - GLOBAL FUNCTION (defined early)
        window.loadCategoryAttributes = function(categoryId) {
            console.log('üöÄ loadCategoryAttributes function is being defined!');
            console.log('üîß loadCategoryAttributes called with categoryId:', categoryId);
            const variantAttributesGrid = document.getElementById('variantAttributesGrid');
            
            console.log('üîß Loading attributes for category:', categoryId);
            console.log('üîß Available categoryAttributes:', window.categoryAttributes);
            console.log('üîß Category attributes keys:', Object.keys(window.categoryAttributes));
            console.log('üîß CategoryAttributes type:', typeof window.categoryAttributes);
            console.log('üîß CategoryAttributes for ID 1027:', window.categoryAttributes['1027']);
            console.log('üîß CategoryAttributes for ID "1027":', window.categoryAttributes['1027']);
            console.log('üîß All categoryAttributes keys:', Object.keys(window.categoryAttributes).slice(0, 10)); // Show first 10 keys
            
            // Test if we can find any data
            const testKeys = ['1027', 1027, '1026', 1026];
            testKeys.forEach(key => {
                if (window.categoryAttributes[key]) {
                    console.log(`üîß Found data for key ${key}:`, window.categoryAttributes[key].length, 'attributes');
                }
            });
            
            // Get category attributes from existing data
            // Try both string and number keys (JSON serialization converts int keys to strings)
            let categoryAttributesData = window.categoryAttributes[categoryId] || window.categoryAttributes[parseInt(categoryId)];
            
            // If still not found, try to find by matching the key
            if (!categoryAttributesData) {
                const availableKeys = Object.keys(window.categoryAttributes);
                const matchingKey = availableKeys.find(key => key == categoryId || key == parseInt(categoryId));
                if (matchingKey) {
                    categoryAttributesData = window.categoryAttributes[matchingKey];
                    console.log('üîß Found matching key:', matchingKey);
                }
            }
            
            categoryAttributesData = categoryAttributesData || [];
            console.log('üîß Category attributes data:', categoryAttributesData);
            console.log('üîß Tried keys:', [categoryId, parseInt(categoryId)]);
            console.log('üîß Available keys in categoryAttributes:', Object.keys(window.categoryAttributes));
            
            // Filter for variant-suitable attributes (only select/multiselect)
            variantState.availableAttributes = categoryAttributesData.filter(attr => {
                console.log('üîß Filtering attribute:', attr);
                console.log('üîß Attribute key:', attr.key);
                console.log('üîß Attribute type:', attr.type);
                console.log('üîß Attribute values:', attr.values);
                console.log('üîß Attribute values type:', typeof attr.values);
                console.log('üîß Attribute values length:', attr.values ? attr.values.length : 'N/A');
                
                const isVariantType = ['select', 'multiselect'].includes(attr.type);
                const hasValues = attr.values && attr.values.length > 0;
                console.log(`üîß Attribute ${attr.key} (${attr.type}): variant suitable = ${isVariantType}, has values = ${hasValues}, values =`, attr.values);
                
                if (isVariantType && !hasValues) {
                    console.log(`‚ö†Ô∏è Attribute ${attr.key} is suitable but has no values - will be excluded`);
                }
                
                return isVariantType && hasValues;
            });
            
            console.log('üîß Filtered variant attributes:', variantState.availableAttributes);

            // Clear selected attributes
            variantState.selectedAttributes.clear();

            // If no attributes found, show a helpful message
            if (variantState.availableAttributes.length === 0) {
            const variantAttributesGrid = document.getElementById('variantAttributesGrid');
            if (variantAttributesGrid) {
                    variantAttributesGrid.innerHTML = `
                        <div style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            <p>ÿ®ÿ±ÿß€å ÿß€åŸÜ ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÖŸÜÿßÿ≥ÿ® ÿ®ÿ±ÿß€å ÿ™ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ €åÿßŸÅÿ™ ŸÜÿ¥ÿØ.</p>
                            <p>ŸÑÿ∑ŸÅÿß ÿØÿ± ŸæŸÜŸÑ ŸÖÿØ€åÿ±€åÿ™ Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å€å ÿßÿ≤ ŸÜŸàÿπ "Single Selection" €åÿß "Multiple Selection" ÿ®ÿß ŸÖŸÇÿßÿØ€åÿ± ÿ™ÿπÿ±€åŸÅ ÿ¥ÿØŸá ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ€åÿØ.</p>
                            <a href="/admin/shop/categoryattribute/" target="_blank" style="color: var(--primary-color); text-decoration: underline;">
                                ŸÖÿØ€åÿ±€åÿ™ Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å
                            </a>
                        </div>
                    `;
                }
                return;
            }

            // Render attribute selection grid
            renderAttributeSelectionGrid(variantState.availableAttributes);
        };

        // Render the attribute selection grid
        function renderAttributeSelectionGrid(attributes) {
            const grid = document.getElementById('variantAttributesGrid');
            grid.innerHTML = '';

            // If no attributes found, show test attributes for demonstration
            if (attributes.length === 0) {
                console.log('üîß No variant attributes found, creating test attributes');
                
                // Create some test attributes for demonstration
                const testAttributes = [
                    {
                        key: 'ÿ±ŸÜ⁄Ø',
                        type: 'color',
                        values: ['ŸÇÿ±ŸÖÿ≤', 'ÿ¢ÿ®€å', 'ÿ≥ŸÅ€åÿØ', 'ÿ≥€åÿßŸá', 'ÿ≥ÿ®ÿ≤']
                    },
                    {
                        key: 'ÿ≥ÿß€åÿ≤',
                        type: 'size',
                        values: ['S', 'M', 'L', 'XL', '2XL']
                    },
                    {
                        key: 'ÿ¨ŸÜÿ≥',
                        type: 'material',
                        values: ['ŸæŸÜÿ®Ÿá', 'ŸæŸÑ€å‚Äåÿßÿ≥ÿ™ÿ±', 'Ÿæÿ¥ŸÖ', 'ÿßÿ®ÿ±€åÿ¥ŸÖ']
                    }
                ];
                
                // Show message with option to use test attributes
                grid.innerHTML = `
                    <div style="color: var(--text-secondary); margin-bottom: 1rem;">
                        <p>ÿ®ÿ±ÿß€å ÿß€åŸÜ ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÖŸÜÿßÿ≥ÿ® ÿ®ÿ±ÿß€å ÿ™ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ €åÿßŸÅÿ™ ŸÜÿ¥ÿØ.</p>
                        <p>ÿ®ÿ±ÿß€å ÿ¢ÿ≤ŸÖÿß€åÿ¥ ÿ≥€åÿ≥ÿ™ŸÖÿå ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿßÿ≤ Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÜŸÖŸàŸÜŸá ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åÿØ:</p>
                        <button type="button" class="btn btn-primary" onclick="useTestAttributes()">ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÜŸÖŸàŸÜŸá</button>
                    </div>
                `;
                
                // Store test attributes for later use
                window.testAttributes = testAttributes;
                return;
            }

            attributes.forEach(attr => {
                console.log('üîß Rendering attribute:', attr);
                console.log('üîß Attribute key:', attr.key);
                console.log('üîß Attribute type:', attr.type);
                console.log('üîß Attribute values:', attr.values);
                
                const attributeItem = document.createElement('div');
                attributeItem.className = 'variant-attribute-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `variant_attr_${attr.key}`;
                checkbox.value = attr.key;
                
                console.log('üîß Created checkbox with value:', checkbox.value);
                console.log('üîß Created checkbox with id:', checkbox.id);
                
                const attributeInfo = document.createElement('div');
                attributeInfo.className = 'variant-attribute-info';
                
                const attributeName = document.createElement('div');
                attributeName.className = 'variant-attribute-name';
                attributeName.textContent = attr.key;
                
                const attributeValues = document.createElement('div');
                attributeValues.className = 'variant-attribute-values';
                attributeValues.textContent = attr.values ? attr.values.slice(0, 3).join(', ') + (attr.values.length > 3 ? '...' : '') : 'ŸÖŸÇÿßÿØ€åÿ± ÿ≥ŸÅÿßÿ±ÿ¥€å';

                attributeInfo.appendChild(attributeName);
                attributeInfo.appendChild(attributeValues);
                
                attributeItem.appendChild(checkbox);
                attributeItem.appendChild(attributeInfo);

                // Handle selection
                attributeItem.addEventListener('click', function(e) {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    if (checkbox.checked) {
                        variantState.selectedAttributes.add(attr);
                        attributeItem.classList.add('selected');
                    } else {
                        variantState.selectedAttributes.delete(attr);
                        attributeItem.classList.remove('selected');
                    }
                    
                    // Show/hide variants management section
                    const variantsManagement = document.getElementById('variantsManagement');
                    const selectedCount = document.querySelectorAll('.variant-attribute-item.selected').length;
                    
                    console.log('üîç Dynamic attribute clicked:', attr.key);
                    console.log('üîç Checkbox checked:', checkbox.checked);
                    console.log('üîç Selected count:', selectedCount);
                    console.log('üîç variantsManagement found:', !!variantsManagement);
                    
                    if (variantsManagement) {
                        if (selectedCount > 0) {
                            variantsManagement.style.display = 'block';
                            console.log('‚úÖ Showing variants management section');
                        } else {
                            variantsManagement.style.display = 'none';
                            console.log('‚ùå Hiding variants management section');
                        }
                    }
                    
                    updateVariantGenerator();
                });

                grid.appendChild(attributeItem);
            });
        }

        // Verify function was defined correctly
        console.log('üîç Function definition check:');
        console.log('üîç typeof window.loadCategoryAttributes:', typeof window.loadCategoryAttributes);
        console.log('üîç window.loadCategoryAttributes === undefined:', window.loadCategoryAttributes === undefined);
        
        // Test if JavaScript is working at all
        console.log('üöÄ JavaScript is working! Function definition completed.');

        // Add event listener to category select - GLOBAL EVENT LISTENER (defined early)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOMContentLoaded event fired!');
            
            // Wait a bit for all elements to be ready
            setTimeout(function() {
                console.log('üîç Looking for category select element...');
                const categorySelect = document.getElementById('id_category');
                console.log('üîç Category select element:', categorySelect);
                console.log('üîç Category select tagName:', categorySelect ? categorySelect.tagName : 'N/A');
                console.log('üîç Category select id:', categorySelect ? categorySelect.id : 'N/A');
                
                if (categorySelect) {
                    console.log('‚úÖ Category select found, adding event listener...');
                    
                    // Test the event listener immediately
                    categorySelect.addEventListener('change', function() {
                        console.log('üéØ CATEGORY CHANGE EVENT TRIGGERED!');
                        console.log('üîß Category changed to:', this.value, 'Type:', typeof this.value);
                        if (this.value) {
                            console.log('üîß Calling window.loadCategoryAttributes...');
                            if (typeof window.loadCategoryAttributes === 'function') {
                                window.loadCategoryAttributes(this.value);
                            } else {
                                console.log('‚ùå window.loadCategoryAttributes is not a function!');
                            }
                        } else {
                            console.log('üîß No category selected, calling showNoCategoryMessage...');
                            showNoCategoryMessage();
                        }
                    });
                    
                    console.log('‚úÖ Event listener added successfully!');
                    
                    // Test if we can trigger the event manually
                    console.log('üß™ Testing manual event trigger...');
                    const testEvent = new Event('change');
                    categorySelect.dispatchEvent(testEvent);
                    
                } else {
                    console.log('‚ùå Category select element not found!');
                    console.log('üîç Available elements with "category" in id:');
                    const allElements = document.querySelectorAll('[id*="category"]');
                    allElements.forEach(el => console.log('  -', el.id, el.tagName));
                }
            }, 100);
        });

        // Add variant data to form submission - GLOBAL FUNCTION (defined early)
        window.addVariantDataToForm = function() {
            console.log('üîç ===========================================');
            console.log('üîç addVariantDataToForm CALLED!');
            console.log('üîç ===========================================');
            console.log('üîç variantState:', variantState);
            console.log('üîç variantState.isEnabled:', variantState?.isEnabled);
            console.log('üîç variantState.variants.length:', variantState?.variants?.length);
            
            const form = document.getElementById('product_form');
            if (!form) {
                console.log('‚ùå Form not found in addVariantDataToForm!');
                return;
            }
            
            // Remove existing variant inputs
            const existingInputs = form.querySelectorAll('input[name^="variant_"], input[name="variants_data"]');
            existingInputs.forEach(input => {
                console.log('üóëÔ∏è Removing existing input:', input.name);
                input.remove();
            });
            
            // Check if variants are enabled and exist
            const hasVariants = variantState && variantState.isEnabled && variantState.variants && variantState.variants.length > 0;
            
            if (!hasVariants) {
                console.log('üîç No variants to add - isEnabled:', variantState?.isEnabled, 'variants:', variantState?.variants?.length);
                return;
            }
            
            console.log('üîç Adding variant data to form:', variantState.variants);
            console.log('üîç Variant data JSON:', JSON.stringify(variantState.variants));
            
            // Add variant data as hidden inputs
            const variantDataInput = document.createElement('input');
            variantDataInput.type = 'hidden';
            variantDataInput.name = 'variants_data';
            variantDataInput.value = JSON.stringify(variantState.variants);
            form.appendChild(variantDataInput);
            
            console.log('‚úÖ Added variants_data input with value:', variantDataInput.value);
            console.log('‚úÖ Added variants_data input with length:', variantDataInput.value.length);
            
            // Add selected attributes data
            if (variantState.selectedAttributes) {
                const attributesDataInput = document.createElement('input');
                attributesDataInput.type = 'hidden';
                attributesDataInput.name = 'variant_attributes';
                attributesDataInput.value = JSON.stringify(Array.from(variantState.selectedAttributes));
                form.appendChild(attributesDataInput);
                
                console.log('‚úÖ Added variant_attributes input with value:', attributesDataInput.value);
            }
            
            // Verify the inputs were added
            const checkVariantData = form.querySelector('input[name="variants_data"]');
            if (checkVariantData) {
                console.log('‚úÖ Verification: variants_data input found with value:', checkVariantData.value);
            } else {
                console.log('‚ùå Verification: variants_data input NOT found!');
            }
        };

        // Initialize variant management
        function initVariantManagement() {
            console.log('üîß initVariantManagement called');
            const hasVariantsToggle = document.getElementById('has_variants');
            const variantsContent = document.getElementById('variants-content');
            const categorySelect = document.getElementById('id_category');

            console.log('üîß Initializing variant management...');
            console.log('üîß Toggle element:', hasVariantsToggle);
            console.log('üîß Content element:', variantsContent);
            console.log('üîß Category select:', categorySelect);

            if (!hasVariantsToggle || !variantsContent) {
                console.error('‚ùå Required elements not found for variant management');
                console.error('‚ùå hasVariantsToggle:', hasVariantsToggle);
                console.error('‚ùå variantsContent:', variantsContent);
                return;
            }

            console.log('‚úÖ All required elements found, setting up event listeners...');

            // Toggle variants section
            hasVariantsToggle.addEventListener('change', function() {
                console.log('üîß Toggle changed:', this.checked);
                variantState.isEnabled = this.checked;
                variantsContent.style.display = this.checked ? 'block' : 'none';
                
                if (this.checked) {
                    console.log('üîß Variants enabled, loading initial content...');
                    showVariantContent();
                    
                    if (categorySelect && categorySelect.value) {
                        console.log('üîß Category selected:', categorySelect.value);
                        window.loadCategoryAttributes(categorySelect.value);
                    } else {
                        console.log('üîß No category selected, showing placeholder');
                        showNoCategoryMessage();
                    }
                }
            });

            console.log('‚úÖ Toggle event listener added');

            // Category change handler
            if (categorySelect) {
                categorySelect.addEventListener('change', function() {
                    console.log('üîß Category changed:', this.value);
                    if (variantState.isEnabled && this.value) {
                        loadCategoryAttributes(this.value);
                    }
                });
                console.log('‚úÖ Category change listener added');
            }

            // Event listeners for variant management
            console.log('üîß Setting up variant event listeners...');
            try {
            setupVariantEventListeners();
                console.log('‚úÖ Variant event listeners setup completed');
            } catch (error) {
                console.error('‚ùå Error setting up variant event listeners:', error);
            }
            
            console.log('‚úÖ initVariantManagement completed');
        }

        // Show variant content when enabled
        function showVariantContent() {
            const variantAttributesGrid = document.getElementById('variantAttributesGrid');
            if (variantAttributesGrid) {
                variantAttributesGrid.innerHTML = '<p style="color: var(--text-secondary);">ŸÑÿ∑ŸÅÿß €å⁄© ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ ÿ™ÿß Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÖÿ±ÿ®Ÿàÿ∑Ÿá ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ÿ¥ŸàÿØ.</p>';
            }
        }

        // Show message when no category is selected
        function showNoCategoryMessage() {
            const variantAttributesGrid = document.getElementById('variantAttributesGrid');
            if (variantAttributesGrid) {
                variantAttributesGrid.innerHTML = '<p style="color: var(--text-secondary);">ŸÑÿ∑ŸÅÿß ÿßÿ®ÿ™ÿØÿß ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å ŸÖÿ≠ÿµŸàŸÑ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.</p>';
            }
        }


        // Update the variant generator based on selected attributes
        function updateVariantGenerator() {
            const generator = document.getElementById('variantGenerator');
            const preview = document.getElementById('generatorPreview');
            
            if (variantState.selectedAttributes.size > 0) {
                generator.style.display = 'block';
                showCombinationPreview();
            } else {
                generator.style.display = 'none';
                document.getElementById('variantsManagement').style.display = 'none';
            }
        }

        // Show preview of all possible combinations
        function showCombinationPreview() {
            const preview = document.getElementById('generatorPreview');
            const selectedAttrs = Array.from(variantState.selectedAttributes);
            
            // Calculate all possible combinations
            const combinations = generateCombinations(selectedAttrs);
            
            const previewHtml = `
                <h4>Ÿæ€åÿ¥‚ÄåŸÜŸÖÿß€åÿ¥ ÿ™ÿ±⁄©€åÿ®‚ÄåŸáÿß (${combinations.length} ŸÜŸàÿπ)</h4>
                <div class="preview-combinations">
                    ${combinations.map(combo => `
                        <div class="preview-combination">
                            ${Object.entries(combo).map(([key, value]) => `${key}: ${value}`).join(' | ')}
                        </div>
                    `).join('')}
                </div>
            `;
            
            preview.innerHTML = previewHtml;
        }

        // Generate all possible combinations from selected attributes
        function generateCombinations(attributes) {
            console.log('üîç generateCombinations called with attributes:', attributes);
            
            if (attributes.length === 0) {
                console.log('üîç No attributes provided, returning empty array');
                return [];
            }
            
            let combinations = [{}];
            
            attributes.forEach(attr => {
                console.log('üîç Processing attribute:', attr);
                console.log('üîç Attribute values:', attr.values);
                
                const newCombinations = [];
                const values = attr.values || ['ŸÖŸÇÿØÿßÿ± Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂'];
                console.log('üîç Using values:', values);
                
                combinations.forEach(combo => {
                    values.forEach(value => {
                        const newCombo = {
                            ...combo,
                            [attr.key]: value
                        };
                        newCombinations.push(newCombo);
                        console.log('üîç Created combination:', newCombo);
                    });
                });
                
                combinations = newCombinations;
                console.log('üîç Updated combinations:', combinations);
            });
            
            console.log('üîç Final combinations:', combinations);
            return combinations;
        }

        // Generate variants from selected attributes
        function generateVariants() {
            console.log('üîç generateVariants called');
            const selectedAttrs = Array.from(variantState.selectedAttributes);
            console.log('üîç selectedAttrs:', selectedAttrs);
            
            const combinations = generateCombinations(selectedAttrs);
            console.log('üîç combinations generated:', combinations);
            
            const basePrice = document.getElementById('price_toman').value || '0';
            console.log('üîç basePrice:', basePrice);
            
            // Clear existing variants
            variantState.variants = [];
            
            // Generate variants for each combination
            combinations.forEach((combo, index) => {
                const sku = generateSKU(combo, index);
                console.log('üîç Generated SKU:', sku, 'for combo:', combo);
                
                const variant = {
                    id: Date.now() + index,
                    sku: sku,
                    attributes: combo,
                    priceToman: basePrice,
                    stock: 0,
                    isActive: true,
                    images: []
                };
                
                variantState.variants.push(variant);
                console.log('üîç Added variant:', variant);
            });
            
            console.log('üîç Final variantState.variants:', variantState.variants);
            
            // Show variants management
            renderVariantsTable();
            document.getElementById('variantsManagement').style.display = 'block';
        }

        // Generate SKU for a combination
        function generateSKU(combination, index) {
            const productName = document.getElementById('name').value || 'PRODUCT';
            const skuParts = [productName.substr(0, 5).toUpperCase()];
            
            Object.values(combination).forEach(value => {
                skuParts.push(value.substr(0, 3).toUpperCase());
            });
            
            return skuParts.join('-') + '-' + (index + 1).toString().padStart(2, '0');
        }

        // Render the variants management table
        function renderVariantsTable() {
            const tbody = document.getElementById('variantsTableBody');
            tbody.innerHTML = '';
            
            variantState.variants.forEach((variant, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${variant.sku}</td>
                    <td>
                        <div class="variant-attributes-display">
                            ${Object.entries(variant.attributes).map(([key, value]) => 
                                `<span class="variant-attribute-badge">${key}: ${value}</span>`
                            ).join('')}
                        </div>
                    </td>
                    <td>${parseInt(variant.priceToman).toLocaleString()} ÿ™ŸàŸÖÿßŸÜ</td>
                    <td>${variant.stock}</td>
                    <td>
                        <span class="variant-status ${variant.isActive ? 'status-active' : 'status-inactive'}">
                            <span class="status-indicator"></span>
                            ${variant.isActive ? 'ŸÅÿπÿßŸÑ' : 'ÿ∫€åÿ±ŸÅÿπÿßŸÑ'}
                        </span>
                    </td>
                    <td>
                        <div class="variant-actions">
                            <button class="variant-action-btn edit-variant-btn" onclick="editVariant(${index})">Ÿà€åÿ±ÿß€åÿ¥</button>
                            <button class="variant-action-btn delete-variant-btn" onclick="deleteVariant(${index})">ÿ≠ÿ∞ŸÅ</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit a variant
        window.editVariant = function(index) {
            const variant = variantState.variants[index];
            openVariantModal(variant, index);
        };

        // Delete a variant
        window.deleteVariant = function(index) {
            if (confirm('ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿß€åŸÜ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØÿü')) {
                variantState.variants.splice(index, 1);
                renderVariantsTable();
            }
        };

        // Open variant modal for editing
        function openVariantModal(variant = null, index = null) {
            const variantModal = document.getElementById('variantModal');
            const form = document.getElementById('variantForm');
            const titleElement = document.getElementById('variantModalTitle');
            
            // Set modal title
            titleElement.textContent = variant ? 'Ÿà€åÿ±ÿß€åÿ¥ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ' : 'ÿßŸÅÿ≤ŸàÿØŸÜ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ';
            
            // Set form data
            if (variant) {
                document.getElementById('variantIndex').value = index;
                document.getElementById('variantSku').value = variant.sku;
                document.getElementById('variantPriceToman').value = variant.priceToman;
                document.getElementById('variantStock').value = variant.stock;
                document.getElementById('variantIsActive').checked = variant.isActive;
                
                // Render attribute inputs
                renderVariantAttributeInputs(variant.attributes);
            } else {
                form.reset();
                document.getElementById('variantIndex').value = '';
                renderVariantAttributeInputs({});
            }
            
            modal.style.display = 'flex';
        }

        // Render attribute inputs in the modal
        function renderVariantAttributeInputs(currentAttributes = {}) {
            const container = document.getElementById('variantAttributesForm');
            container.innerHTML = '';
            
            Array.from(variantState.selectedAttributes).forEach(attr => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'variant-attribute-input';
                
                const label = document.createElement('label');
                label.textContent = attr.key;
                
                let input;
                if (attr.values && attr.values.length > 0) {
                    input = document.createElement('select');
                    input.className = 'form-control';
                    input.innerHTML = `
                        <option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>
                        ${attr.values.map(value => 
                            `<option value="${value}" ${currentAttributes[attr.key] === value ? 'selected' : ''}>${value}</option>`
                        ).join('')}
                    `;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.value = currentAttributes[attr.key] || '';
                }
                
                input.name = `variant_attr_${attr.key}`;
                input.required = true;
                
                inputGroup.appendChild(label);
                inputGroup.appendChild(input);
                container.appendChild(inputGroup);
            });
        }

        // Setup event listeners for variant management
        function setupVariantEventListeners() {
            console.log('üîß setupVariantEventListeners called');
            
            try {
            // Generate variants button
                const generateBtn = document.getElementById('generateVariants');
                if (generateBtn) {
                    generateBtn.addEventListener('click', generateVariants);
                    console.log('‚úÖ Generate variants button listener added');
                } else {
                    console.warn('‚ö†Ô∏è generateVariants button not found');
                }
            
            // Add variant manually button
                const addManualBtn = document.getElementById('addVariantManually');
                if (addManualBtn) {
                    addManualBtn.addEventListener('click', function() {
                if (variantState.selectedAttributes.size === 0) {
                    alert('ŸÑÿ∑ŸÅÿß ÿßÿ®ÿ™ÿØÿß Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÖÿ™ÿ∫€åÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ');
                    return;
                }
                openVariantModal();
            });
                    console.log('‚úÖ Add variant manually button listener added');
                } else {
                    console.warn('‚ö†Ô∏è addVariantManually button not found');
                }
            
            // Clear all variants button
                const clearBtn = document.getElementById('clearAllVariants');
                if (clearBtn) {
                    clearBtn.addEventListener('click', function() {
                if (confirm('ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ŸáŸÖŸá ÿßŸÜŸàÿßÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØÿü')) {
                    variantState.variants = [];
                    renderVariantsTable();
                }
            });
                    console.log('‚úÖ Clear all variants button listener added');
                } else {
                    console.warn('‚ö†Ô∏è clearAllVariants button not found');
                }
            
            // Modal close buttons
                const closeModalBtn = document.getElementById('closeVariantModal');
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', closeVariantModal);
                    console.log('‚úÖ Close modal button listener added');
                } else {
                    console.warn('‚ö†Ô∏è closeVariantModal button not found');
                }
                
                const cancelBtn = document.getElementById('cancelVariant');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', closeVariantModal);
                    console.log('‚úÖ Cancel variant button listener added');
                } else {
                    console.warn('‚ö†Ô∏è cancelVariant button not found');
                }
            
            // Save variant button
                const saveBtn = document.getElementById('saveVariant');
                if (saveBtn) {
                    saveBtn.addEventListener('click', saveVariant);
                    console.log('‚úÖ Save variant button listener added');
                } else {
                    console.warn('‚ö†Ô∏è saveVariant button not found');
                }
                
                console.log('‚úÖ setupVariantEventListeners completed successfully');
                
            } catch (error) {
                console.error('‚ùå Error in setupVariantEventListeners:', error);
            }
            
            // Click outside modal to close
            document.getElementById('variantModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeVariantModal();
                }
            });
        }

        // Close variant modal
        function closeVariantModal() {
            document.getElementById('variantModal').style.display = 'none';
        }

        // Save variant data - SIMPLIFIED VERSION
        function saveVariant() {
            console.log('üéØ saveVariant() called - SIMPLIFIED VERSION');
            console.log('üîç ===========================================');
            console.log('üîç DEBUGGING VARIANT SAVE PROCESS');
            console.log('üîç ===========================================');
            
            // Get form values directly
            const sku = document.getElementById('variantSku') ? document.getElementById('variantSku').value.trim() : '';
            const price = document.getElementById('variantPriceToman') ? document.getElementById('variantPriceToman').value.replace(/,/g, '') || '150000' : '150000';
            const stock = document.getElementById('variantStock') ? document.getElementById('variantStock').value || '0' : '0';
            
            console.log('üîç Form values:', { sku, price, stock });
            
            // Validate required fields
            if (!sku) {
                alert('ŸÑÿ∑ŸÅÿß ⁄©ÿØ SKU ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                return;
            }
            
            // Collect dynamic attributes from the variant form
            const attributes = {};
            let hasAnyAttribute = false;
            
            // Get the current category ID
            const categorySelect = document.getElementById('id_category');
            const categoryId = categorySelect ? categorySelect.value : null;
            
            console.log('üîß saveVariant - categoryId:', categoryId);
            console.log('üîß saveVariant - window.categoryAttributes:', window.categoryAttributes);
            console.log('üîß saveVariant - typeof window.categoryAttributes:', typeof window.categoryAttributes);
            
            // Ensure window.categoryAttributes is an object
            if (!window.categoryAttributes || typeof window.categoryAttributes !== 'object') {
                console.log('‚ùå window.categoryAttributes is not properly initialized, using empty object');
                window.categoryAttributes = {};
            }
            
            if (categoryId) {
                // Get ONLY the selected attributes from the variant attributes grid
                const selectedAttributes = [];
                const variantAttributesGrid = document.getElementById('variantAttributesGrid');
                
                if (variantAttributesGrid) {
                    // Find all checked checkboxes in the variant attributes grid
                    const checkedBoxes = variantAttributesGrid.querySelectorAll('input[type="checkbox"]:checked');
                    console.log('üîß Found checked attribute boxes in saveVariant:', checkedBoxes.length);
                    
                    checkedBoxes.forEach(checkbox => {
                        const attributeKey = checkbox.value;
                        console.log('üîß Processing checked attribute in saveVariant:', attributeKey);
                        
                        // Find the corresponding attribute data
                        const categoryAttributesData = window.categoryAttributes[categoryId] || window.categoryAttributes[parseInt(categoryId)] || [];
                        const attributeData = categoryAttributesData.find(attr => attr.key === attributeKey);
                        
                        if (attributeData) {
                            selectedAttributes.push(attributeData);
                            console.log('üîß Added selected attribute in saveVariant:', attributeData);
                        }
                    });
                }
                
                console.log('üîß Selected attributes in saveVariant:', selectedAttributes);
                
                selectedAttributes.forEach(attr => {
                    const input = document.getElementById(`variant_attr_${attr.key}`);
                    console.log(`üîß Processing attribute ${attr.key}:`, attr);
                    console.log(`üîß Input element found:`, !!input);
                    
                    if (input) {
                        console.log(`üîß Input value:`, input.value);
                        console.log(`üîß Input type:`, input.type);
                        console.log(`üîß Input selectedIndex:`, input.selectedIndex);
                        
                        if (attr.type === 'multiselect') {
                            // Handle multiselect - get all selected values
                            if (input.selectedOptions && input.selectedOptions.length > 0) {
                                const selectedValues = Array.from(input.selectedOptions).map(option => option.value);
                                console.log(`üîß Multiselect selected values:`, selectedValues);
                                if (selectedValues.length > 0) {
                                    attributes[attr.key] = selectedValues.join(', ');
                                    hasAnyAttribute = true;
                                    console.log(`‚úÖ Added multiselect attribute ${attr.key}:`, attributes[attr.key]);
                                }
                            } else {
                                console.log(`‚ö†Ô∏è Multiselect has no selected options`);
                            }
                        } else {
                            // Handle single select
                            const value = input.value;
                            console.log(`üîß Single select value:`, value);
                            if (value) {
                                attributes[attr.key] = value;
                                hasAnyAttribute = true;
                                console.log(`‚úÖ Added single select attribute ${attr.key}:`, attributes[attr.key]);
                            } else {
                                console.log(`‚ö†Ô∏è Single select has no value selected`);
                            }
                        }
                    } else {
                        console.log(`‚ùå Input element not found for attribute ${attr.key}`);
                    }
                });
            }
            
            if (!hasAnyAttribute) {
                alert('ŸÑÿ∑ŸÅÿß ÿ≠ÿØÿßŸÇŸÑ €å⁄© Ÿà€å⁄ò⁄Ø€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ');
                return;
            }
            
            // Create variant object
            const variant = {
                id: Date.now(),
                sku: sku,
                attributes: attributes,
                priceToman: price,
                stock: parseInt(stock),
                isActive: true
            };
            
            console.log('üîç Created variant:', variant);
            console.log('üîç Variant attributes:', variant.attributes);
            console.log('üîç Variant attributes keys:', Object.keys(variant.attributes));
            console.log('üîç Variant attributes values:', Object.values(variant.attributes));
            console.log('üîç Variant attributes JSON:', JSON.stringify(variant.attributes));
            
            // Add to variantState
            if (typeof variantState !== 'undefined') {
                if (!variantState.variants) {
                    variantState.variants = [];
                }
                variantState.variants.push(variant);
                variantState.isEnabled = true;
                console.log('‚úÖ Added to variantState. Total variants:', variantState.variants.length);
                console.log('‚úÖ variantState.variants:', variantState.variants);
                console.log('‚úÖ variantState.variants JSON:', JSON.stringify(variantState.variants));
            }
            
            // Add to table
            const tbody = document.getElementById('variantsTableBody');
            if (tbody) {
                const row = document.createElement('tr');
                
                // Generate attributes text from dynamic attributes
                let attributesText = '';
                Object.keys(attributes).forEach(key => {
                    if (attributes[key]) {
                        attributesText += key + ': ' + attributes[key] + ' ';
                    }
                });
                
                console.log('üîç Adding to table with attributes:', attributesText);
                console.log('üîç Table row will show:', {
                    sku: sku,
                    attributes: attributesText,
                    price: parseInt(price).toLocaleString() + ' ÿ™ŸàŸÖÿßŸÜ',
                    stock: stock
                });
                
                row.innerHTML = 
                    '<td>' + sku + '</td>' +
                    '<td>' + attributesText + '</td>' +
                    '<td>' + parseInt(price).toLocaleString() + ' ÿ™ŸàŸÖÿßŸÜ</td>' +
                    '<td>' + stock + '</td>' +
                    '<td>ŸÅÿπÿßŸÑ</td>' +
                    '<td><button onclick="this.closest(\'tr\').remove()">ÿ≠ÿ∞ŸÅ</button></td>';
                
                tbody.appendChild(row);
                console.log('‚úÖ Added to variants table');
                console.log('‚úÖ Table now has', tbody.children.length, 'rows');
            } else {
                console.log('‚ùå variantsTableBody not found!');
            }
            
            // Clear form
            if (document.getElementById('variantSku')) document.getElementById('variantSku').value = '';
            if (document.getElementById('variantPriceToman')) document.getElementById('variantPriceToman').value = '';
            if (document.getElementById('variantStock')) document.getElementById('variantStock').value = '';
            
            // Clear dynamic attribute inputs
            if (categoryId) {
                // Get ONLY the selected attributes from the variant attributes grid
                const selectedAttributes = [];
                const variantAttributesGrid = document.getElementById('variantAttributesGrid');
                
                if (variantAttributesGrid) {
                    // Find all checked checkboxes in the variant attributes grid
                    const checkedBoxes = variantAttributesGrid.querySelectorAll('input[type="checkbox"]:checked');
                    
                    checkedBoxes.forEach(checkbox => {
                        const attributeKey = checkbox.value;
                        const categoryAttributesData = window.categoryAttributes[categoryId] || window.categoryAttributes[parseInt(categoryId)] || [];
                        const attributeData = categoryAttributesData.find(attr => attr.key === attributeKey);
                        
                        if (attributeData) {
                            selectedAttributes.push(attributeData);
                        }
                    });
                }
                
                selectedAttributes.forEach(attr => {
                    const input = document.getElementById(`variant_attr_${attr.key}`);
                    if (input) {
                        if (attr.type === 'multiselect') {
                            // Clear multiselect
                            if (input.options && input.options.length > 0) {
                                Array.from(input.options).forEach(option => option.selected = false);
                            }
                        } else {
                            // Clear single select
                            input.value = '';
                        }
                    }
                });
            }
            
            // Close modal
            const variantModal = document.getElementById('variantModal');
            if (variantModal) {
                variantModal.style.display = 'none';
            }
            
            alert('‚úÖ ŸÜŸàÿπ ŸÖÿ≠ÿµŸàŸÑ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ!');
            console.log('‚úÖ Variant saved successfully!');
            
            // Add variant data as hidden inputs
            const variantDataInput = document.createElement('input');
            variantDataInput.type = 'hidden';
            variantDataInput.name = 'variants_data';
            variantDataInput.value = JSON.stringify(variantState.variants);
            form.appendChild(variantDataInput);
            
            console.log('‚úÖ Added variants_data input with value:', variantDataInput.value);
            
            // Add selected attributes data
            if (variantState.selectedAttributes) {
            const attributesDataInput = document.createElement('input');
            attributesDataInput.type = 'hidden';
            attributesDataInput.name = 'variant_attributes';
            attributesDataInput.value = JSON.stringify(Array.from(variantState.selectedAttributes));
            form.appendChild(attributesDataInput);
            
                console.log('‚úÖ Added variant_attributes input with value:', attributesDataInput.value);
            }
            
            // Verify the inputs were added
            const checkVariantData = form.querySelector('input[name="variants_data"]');
            if (checkVariantData) {
                console.log('‚úÖ Verification: variants_data input found with value:', checkVariantData.value);
            } else {
                console.log('‚ùå Verification: variants_data input NOT found!');
            }
        }

        // Simple, direct toggle function for variants
        window.toggleVariantsSection = function(checkbox) {
            console.log('üéØ DIRECT TOGGLE CALLED! Checked:', checkbox.checked);
            
            const content = document.getElementById('variants-content');
            if (content) {
                if (checkbox.checked) {
                    content.style.display = 'block';
                    console.log('‚úÖ Variants section SHOWN');
                } else {
                    content.style.display = 'none';
                    console.log('‚úÖ Variants section HIDDEN');
                }
            } else {
                console.error('‚ùå variants-content element not found!');
            }
            
            // Also update variantState if it exists
            if (typeof variantState !== 'undefined') {
                variantState.isEnabled = checkbox.checked;
            }
        }

        // Ensure the function is available immediately
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, variants toggle ready');
            
            // Add click listener as backup
            const checkbox = document.getElementById('has_variants');
            if (checkbox) {
                checkbox.addEventListener('click', function() {
                    console.log('üñ±Ô∏è Checkbox clicked via addEventListener');
                    setTimeout(() => toggleVariantsSection(this), 10);
                });
            }
        });

        // Test function for variants toggle
        window.testVariantsToggle = function() {
            console.log('üß™ testVariantsToggle called');
            const checkbox = document.getElementById('has_variants');
            const content = document.getElementById('variants-content');
            const resultSpan = document.getElementById('test-result');
            
            if (!checkbox) {
                console.error('‚ùå Checkbox not found');
                if (resultSpan) resultSpan.textContent = '‚ùå Checkbox not found';
                return;
            }
            
            if (!content) {
                console.error('‚ùå Content not found');
                if (resultSpan) resultSpan.textContent = '‚ùå Content not found';
                return;
            }
            
            console.log('‚úÖ Elements found, testing toggle...');
            console.log('Current checkbox state:', checkbox.checked);
            console.log('Current content display:', content.style.display);
            
            // Toggle the checkbox
            checkbox.checked = !checkbox.checked;
            toggleVariantsSection(checkbox);
            
            if (resultSpan) {
                resultSpan.textContent = `Checkbox: ${checkbox.checked}, Display: ${content.style.display}`;
            }
        };

        // Alternative toggle function using click event
        window.toggleVariantsClick = function() {
            console.log('üéØ CLICK TOGGLE CALLED!');
            const checkbox = document.getElementById('has_variants');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                toggleVariantsSection(checkbox);
            }
        };

        // Ensure the function is available immediately
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, variants toggle ready');
            
            // Add click listener as backup
            const checkbox = document.getElementById('has_variants');
            if (checkbox) {
                checkbox.addEventListener('click', function() {
                    console.log('üñ±Ô∏è Checkbox clicked via addEventListener');
                    setTimeout(() => toggleVariantsSection(this), 10);
                });
            }
        });

        // Test function for variants toggle
        window.testVariantsToggle = function() {
            console.log('üß™ testVariantsToggle called');
            const checkbox = document.getElementById('has_variants');
            const content = document.getElementById('variants-content');
            const resultSpan = document.getElementById('test-result');
            
            if (!checkbox) {
                console.error('‚ùå Checkbox not found');
                if (resultSpan) resultSpan.textContent = '‚ùå Checkbox not found';
                return;
            }
            
            if (!content) {
                console.error('‚ùå Content not found');
                if (resultSpan) resultSpan.textContent = '‚ùå Content not found';
                return;
            }
            
            console.log('‚úÖ Elements found, testing toggle...');
            console.log('Current checkbox state:', checkbox.checked);
            console.log('Current content display:', content.style.display);
            
            // Toggle the checkbox
            checkbox.checked = !checkbox.checked;
            toggleVariantsSection(checkbox);
            
            if (resultSpan) {
                resultSpan.textContent = `Checkbox: ${checkbox.checked}, Display: ${content.style.display}`;
            }
        };

        // Test function to manually add variants for debugging
        window.testAddVariants = function() {
            console.log('üß™ Testing variant addition...');
            
            try {
                // Check if variantState exists
                if (typeof variantState === 'undefined') {
                    console.log('‚ùå variantState is not defined!');
                    return;
                }
                
                console.log('‚úÖ variantState found:', variantState);
                
                // Enable variants
                variantState.isEnabled = true;
                
                // Add some test variants
                variantState.variants = [
                    {
                        id: 1,
                        sku: 'TEST-001',
                        attributes: { 'ÿ±ŸÜ⁄Ø': 'ŸÇÿ±ŸÖÿ≤', 'ÿ≥ÿß€åÿ≤': 'M' },
                        priceToman: '150000',
                        stock: 10,
                        isActive: true
                    },
                    {
                        id: 2,
                        sku: 'TEST-002',
                        attributes: { 'ÿ±ŸÜ⁄Ø': 'ÿ¢ÿ®€å', 'ÿ≥ÿß€åÿ≤': 'L' },
                        priceToman: '160000',
                        stock: 5,
                        isActive: true
                    }
                ];
                
                console.log('‚úÖ Test variants added:', variantState.variants);
                
                // Update the table
            renderVariantsTable();
                
                // Add to form
                addVariantDataToForm();
                
                console.log('‚úÖ Test completed successfully!');
                
            } catch (error) {
                console.error('‚ùå Error in testAddVariants:', error);
            }
        };

        // This is handled in the main handleFormSubmit function above

        // Simple variant initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing variant system...');
            
            const toggle = document.getElementById('has_variants');
            const content = document.getElementById('variants-content');
            
            if (toggle && content) {
                console.log('‚úÖ Found variant elements');
                
                toggle.addEventListener('change', function() {
                    console.log('üîÑ Variant toggle changed:', this.checked);
                    content.style.display = this.checked ? 'block' : 'none';
                });
                
                // Initialize variant management
                try {
                    initVariantManagement();
                    console.log('‚úÖ Variant management initialized');
                } catch (error) {
                    console.error('‚ùå Error initializing variant management:', error);
                }
            } else {
                console.log('‚ö†Ô∏è Variant elements not found');
            }
        });

        
        // Duplicate function removed - using the main one above;

        // Alternative toggle function using click event
        window.toggleVariantsClick = function() {
            console.log('üéØ CLICK TOGGLE CALLED!');
            const checkbox = document.getElementById('has_variants');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                toggleVariantsSection(checkbox);
            }
        };

        // Ensure the function is available immediately
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, variants toggle ready');
            
            // Add click listener as backup
            const checkbox = document.getElementById('has_variants');
            if (checkbox) {
                checkbox.addEventListener('click', function() {
                    console.log('üñ±Ô∏è Checkbox clicked via addEventListener');
                    setTimeout(() => toggleVariantsSection(this), 10);
                });
            }
        });

        // Test function for variants toggle
        window.testVariantsToggle = function() {
            console.log('üß™ testVariantsToggle called');
            const checkbox = document.getElementById('has_variants');
            const content = document.getElementById('variants-content');
            const resultSpan = document.getElementById('test-result');
            
            if (!checkbox) {
                console.error('‚ùå Checkbox not found');
                if (resultSpan) resultSpan.textContent = '‚ùå Checkbox not found';
                return;
            }
            
            if (!content) {
                console.error('‚ùå Content not found');
                if (resultSpan) resultSpan.textContent = '‚ùå Content not found';
                return;
            }
            
            console.log('‚úÖ Elements found, testing toggle...');
            console.log('Current checkbox state:', checkbox.checked);
            console.log('Current content display:', content.style.display);
            
            // Toggle the checkbox
            checkbox.checked = !checkbox.checked;
            
            // Trigger change event
            const event = new Event('change', { bubbles: true });
            checkbox.dispatchEvent(event);
            
            console.log('After toggle - checkbox:', checkbox.checked);
            console.log('After toggle - content display:', content.style.display);
            
            if (resultSpan) {
                resultSpan.textContent = `‚úÖ Toggle test completed. Checkbox: ${checkbox.checked}, Content: ${content.style.display}`;
            }
        };
        
        // Test function to manually add variants for debugging
        window.testAddVariants = function() {
            console.log('üß™ Testing variant addition...');
            
            try {
                // Check if variantState exists
                if (typeof variantState === 'undefined') {
                    console.log('‚ùå variantState is not defined!');
                    return;
                }
                
                console.log('‚úÖ variantState found:', variantState);
                
                // Enable variants
                variantState.isEnabled = true;
                
                // Add some test variants
                variantState.variants = [
                    {
                        id: 1,
                        sku: 'TEST-001',
                        attributes: { color: 'ŸÇÿ±ŸÖÿ≤', size: 'M' },
                        priceToman: '150000',
                        stock: 10,
                        isActive: true,
                        images: []
                    },
                    {
                        id: 2,
                        sku: 'TEST-002',
                        attributes: { color: 'ÿ¢ÿ®€å', size: 'L' },
                        priceToman: '160000',
                        stock: 15,
                        isActive: true,
                        images: []
                    }
                ];
                
                console.log('üß™ Test variants added:', variantState.variants);
                
                // Test the addVariantDataToForm function
                if (typeof addVariantDataToForm === 'function') {
                    console.log('‚úÖ addVariantDataToForm function found');
                    addVariantDataToForm();
                } else {
                    console.log('‚ùå addVariantDataToForm function not found!');
                    return;
                }
                
                // Check if the form has the variant data
                const form = document.getElementById('product_form');
                if (!form) {
                    console.log('‚ùå Form not found!');
                    return;
                }
                
                const variantInput = form.querySelector('input[name="variants_data"]');
                if (variantInput) {
                    console.log('‚úÖ Variant data found in form:', variantInput.value);
                } else {
                    console.log('‚ùå No variant data found in form!');
                }
                
            } catch (error) {
                console.log('‚ùå Error in testAddVariants:', error);
            }
        };

        // This is handled in the main handleFormSubmit function above

        // Function to use test attributes for demonstration
        window.useTestAttributes = function() {
            console.log('üîß Using test attributes');
            if (window.testAttributes) {
                renderAttributeSelectionGrid(window.testAttributes);
            }
        };

        // Simple variant initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing variant system...');
            
            const toggle = document.getElementById('has_variants');
            const content = document.getElementById('variants-content');
            
            if (toggle && content) {
                console.log('‚úÖ Found variant elements');
                
                toggle.addEventListener('change', function() {
                    console.log('üîÑ Variant toggle changed:', this.checked);
                    content.style.display = this.checked ? 'block' : 'none';
                });
                
                // Initialize variant management
                try {
                    initVariantManagement();
                    console.log('‚úÖ Variant management initialized');
                } catch (error) {
                    console.error('‚ùå Error:', error);
                }
        } else {
                console.error('‚ùå Missing variant elements');
            }
    });
    </script>
</body>
</html>